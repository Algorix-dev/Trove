# UPDATED TROVE CODEBASE - 2025-12-13 00:19:28


========== FILE: app\dashboard\error.tsx ==========
"use client"

import { useEffect } from "react"
import { Button } from "@/components/ui/button"
import { AlertCircle } from "lucide-react"

export default function DashboardError({
    error,
    reset,
}: {
    error: Error & { digest?: string }
    reset: () => void
}) {
    useEffect(() => {
        console.error(error)
    }, [error])

    return (
        <div className="flex h-[400px] w-full flex-col items-center justify-center gap-4 rounded-lg border border-dashed p-4">
            <div className="flex h-20 w-20 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/20">
                <AlertCircle className="h-10 w-10 text-red-600 dark:text-red-400" />
            </div>
            <div className="text-center space-y-2">
                <h2 className="text-xl font-semibold">Something went wrong!</h2>
                <p className="text-muted-foreground max-w-md">
                    We encountered an error while loading your dashboard. Please try again.
                </p>
                {error.digest && (
                    <p className="text-xs text-muted-foreground font-mono">
                        Error ID: {error.digest}
                    </p>
                )}
            </div>
            <Button onClick={() => reset()} variant="outline">
                Try again
            </Button>
        </div>
    )
}


========== FILE: app\dashboard\layout.tsx ==========
import { DashboardHeader } from "@/components/features/dashboard-header"
import { DashboardSidebar } from "@/components/features/dashboard-sidebar"

export const dynamic = 'force-dynamic'

export default function DashboardLayout({
    children,
}: {
    children: React.ReactNode
}) {
    return (
        <div className="h-full relative">
            <div className="hidden h-full md:flex md:w-72 md:flex-col md:fixed md:inset-y-0 z-[80]">
                <DashboardSidebar />
            </div>
            <main className="md:pl-72">
                <DashboardHeader />
                <div className="p-8">
                    <div className="animate-in fade-in zoom-in-95 duration-500">
                        {children}
                    </div>
                </div>
            </main>
        </div>
    )
}


========== FILE: app\dashboard\loading.tsx ==========
import { Skeleton } from "@/components/ui/skeleton"

export default function DashboardLoading() {
    return (
        <div className="space-y-6">
            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
                <div className="flex gap-2">
                    <Skeleton className="h-9 w-24 rounded-full" />
                    <Skeleton className="h-9 w-24" />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                {Array.from({ length: 4 }).map((_, i) => (
                    <Skeleton key={i} className="h-32 rounded-xl" />
                ))}
            </div>

            <div className="grid gap-6 md:grid-cols-2">
                <Skeleton className="h-[300px] rounded-xl" />
                <Skeleton className="h-[300px] rounded-xl" />
            </div>

            <Skeleton className="h-[200px] rounded-xl" />
        </div>
    )
}


========== FILE: app\dashboard\page.tsx ==========
// app/dashboard/page.tsx
import { DashboardStats } from "@/components/features/dashboard-stats"
import { DashboardCharts } from "@/components/features/dashboard-charts"
import { ContinueReading } from "@/components/features/continue-reading"
import { QuickActions } from "@/components/features/quick-actions"
import { ShareInviteModal } from "@/components/features/share-invite-modal"
import { LevelProgress } from "@/components/features/gamification/level-progress"
import { AchievementConfetti } from "@/components/features/gamification/achievement-confetti"
import { DailyGoalCelebration } from "@/components/features/gamification/daily-goal-celebration"
import { LevelUpCelebration } from "@/components/features/gamification/level-up-celebration"
import { ReadingStreakCalendar } from "@/components/features/analytics/reading-streak-calendar"
import { ReadingGoals } from "@/components/features/analytics/reading-goals"
import { createServerSupabaseClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"

export const dynamic = 'force-dynamic'

export default async function DashboardPage() {
    const supabase = createServerSupabaseClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (!user) {
        redirect("/login")
    }

    const { data: profile } = await supabase
        .from('profiles')
        .select('full_name, username, total_xp, current_level')
        .eq('id', user.id)
        .single()

    const { data: levels } = await supabase
        .from('levels')
        .select('*')
        .order('min_xp', { ascending: true })

    const currentLevel = profile?.current_level || 1
    const currentXP = profile?.total_xp || 0

    const levelInfo = levels?.find(l => l.level === currentLevel)
    const nextLevelInfo = levels?.find(l => l.level === currentLevel + 1)

    const nextLevelXP = nextLevelInfo?.min_xp || (levelInfo?.min_xp || 0) + 1000
    const levelTitle = levelInfo?.title || "Reader"

    const name = profile?.username || profile?.full_name?.split(' ')[0] || user.user_metadata?.full_name?.split(' ')[0] || "Reader"
    const hour = new Date().getHours()
    let greeting = "Good Morning"
    if (hour >= 12 && hour < 17) greeting = "Good Afternoon"
    if (hour >= 17) greeting = "Good Evening"

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div>
                    <h2 className="text-3xl font-bold tracking-tight">{greeting}, {name}</h2>
                    <p className="text-muted-foreground">Ready to continue your reading journey?</p>
                </div>
                <div className="flex items-center gap-3">
                    <div className="text-sm text-muted-foreground italic bg-muted/50 px-4 py-2 rounded-full hidden md:block">
                        "A reader lives a thousand lives before he dies." â€” George R.R. Martin
                    </div>
                    <ShareInviteModal />
                </div>
            </div>

            <DashboardStats />

            <div className="grid gap-6 md:grid-cols-2">
                <LevelProgress
                    level={currentLevel}
                    currentXP={currentXP}
                    nextLevelXP={nextLevelXP}
                    levelTitle={levelTitle}
                />
                <ReadingGoals />
            </div>

            <ReadingStreakCalendar />

            <AchievementConfetti />
            <DailyGoalCelebration />
            <LevelUpCelebration />

            <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-7">
                <div className="col-span-1 md:col-span-2 lg:col-span-3 space-y-6">
                    <ContinueReading />
                    <QuickActions />
                </div>
                <div className="col-span-1 md:col-span-2 lg:col-span-4">
                    <DashboardCharts />
                </div>
            </div>
        </div>
    )
}


========== FILE: app\dashboard\analytics\page.tsx ==========
// app/dashboard/analytics/page.tsx
import { AnalyticsCharts } from "@/components/features/analytics/analytics-charts"
import { createServerSupabaseClient } from "@/lib/supabase/server"

export const dynamic = "force-dynamic"

export default async function AnalyticsPage() {
    const supabase = createServerSupabaseClient()
    const { data: sessionData } = await supabase.auth.getSession()
    const userId = sessionData.session?.user.id
    if (!userId) return null

    // Example: fetch basic analytics data for the user (adjust as needed)
    const { data: readingProgress } = await supabase
        .from("reading_progress")
        .select("book_id, progress_percentage, updated_at, books(id, title)")
        .eq("user_id", userId)
        .order("updated_at", { ascending: false })
        .limit(200)

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex items-center justify-between">
                <h2 className="text-3xl font-bold tracking-tight">Analytics</h2>
            </div>

            <AnalyticsCharts userId={userId} readingProgress={readingProgress ?? []} />
        </div>
    )
}


========== FILE: app\dashboard\bookmarks\page.tsx ==========
// app/dashboard/bookmarks/page.tsx (server component)
import { BookmarksList } from "@/components/features/bookmarks/bookmarks-list"
import { createServerSupabaseClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"

export default async function BookmarksPage() {
    const supabase = createServerSupabaseClient()
    const {
        data: { user },
    } = await supabase.auth.getUser()

    if (!user) redirect("/login")

    // Fetch bookmarks with book relation
    const { data: rawBookmarks } = await supabase
        .from("bookmarks")
        .select(`
      id,
      book_id,
      page_number,
      epub_cfi,
      progress_percentage,
      created_at,
      note,
      books (
        id,
        title,
        author,
        cover_url,
        format
      )
    `)
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })

    const bookmarks = (rawBookmarks || []).map((b: any) => ({
        id: b.id,
        book_id: b.book_id,
        page_number: b.page_number ?? null,
        epub_cfi: b.epub_cfi ?? null,
        progress_percentage: b.progress_percentage ?? null,
        created_at: b.created_at,
        note: b.note ?? null,
        // Normalize relation: sometimes Supabase returns array for relation; ensure object
        books: Array.isArray(b.books) ? b.books[0] ?? null : b.books ?? null,
    }))

    return <BookmarksList userId={user.id} bookmarks={bookmarks} />
}


========== FILE: app\dashboard\community\page.tsx ==========
// app/dashboard/community/page.tsx
import { CommunityList } from "@/components/features/community/community-list"
import { createServerSupabaseClient } from "@/lib/supabase/server"

export const dynamic = "force-dynamic"

export default async function CommunityPage() {
    const supabase = createServerSupabaseClient()

    const { data: communities } = await supabase
        .from("communities")
        .select("id, name, description, member_count")
        .order("member_count", { ascending: false })
        .limit(50)

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <div className="space-y-2">
                <h2 className="text-3xl font-bold tracking-tight">Community</h2>
                <p className="text-muted-foreground">Join discussions with fellow readers in our curated communities</p>
            </div>
            <CommunityList communities={communities ?? []} />
        </div>
    )
}


========== FILE: app\dashboard\data-debug\page.tsx ==========
// app/dashboard/data-debug/page.tsx
import DataDebugClient from "@/components/debug/data-debug-client"
import { createServerSupabaseClient } from "@/lib/supabase/server"

export const dynamic = "force-dynamic"

export default async function DataDebugPage() {
    const supabase = createServerSupabaseClient()

    const { data: sessionData } = await supabase.auth.getSession()
    const user = sessionData.session?.user ?? null

    // Counts
    const [{ count: booksCount }, { count: profilesCount }] = await Promise.all([
        supabase.from("books").select("*", { count: "exact", head: true }),
        supabase.from("profiles").select("*", { count: "exact", head: true }),
    ]).catch(() => [{ count: 0 }, { count: 0 }])

    // sample books
    const { data: booksSample } = await supabase
        .from("books")
        .select("id, title, author, cover_url, total_pages")
        .limit(10)

    const rawCookies = null // client-only; we'll let client read document.cookie

    return (
        <div className="p-8 bg-black min-h-screen text-green-400 font-mono text-sm space-y-6">
            <h1 className="text-2xl text-white font-bold">DATA ACCESS DIAGNOSTIC (Server)</h1>

            <section className="space-y-2 border border-gray-800 p-4 rounded">
                <h2 className="text-xl text-white">Auth User (Server)</h2>
                <pre className="bg-gray-900 p-2 rounded overflow-auto">{JSON.stringify(user ?? null, null, 2)}</pre>
            </section>

            <section className="space-y-2 border border-gray-800 p-4 rounded">
                <h2 className="text-xl text-white">RLS Table Counts (Server)</h2>
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-gray-900 p-2 rounded"><strong>Books:</strong> {booksCount ?? '...'}</div>
                    <div className="bg-gray-900 p-2 rounded"><strong>Profiles:</strong> {profilesCount ?? '...'}</div>
                </div>
            </section>

            <section className="space-y-2 border border-gray-800 p-4 rounded">
                <h2 className="text-xl text-white">Books Sample (Server)</h2>
                {(!booksSample || booksSample.length === 0) ? (
                    <div className="text-yellow-500">No books found (Empty Array)</div>
                ) : (
                    <ul className="list-disc pl-5">
                        {booksSample.map(b => (
                            <li key={b.id}>
                                <pre className="text-xs text-gray-300 overflow-auto max-w-sm">{JSON.stringify(b, null, 2)}</pre>
                            </li>
                        ))}
                    </ul>
                )}
            </section>

            {/* interactive client part (login form, cookie clear) */}
            <DataDebugClient initialUser={user} />
        </div>
    )
}


========== FILE: app\dashboard\library\page.tsx ==========
// app/dashboard/library/page.tsx (server component)
import { LibraryContent } from "@/components/features/library/library-content"
import { createServerSupabaseClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"

export default async function LibraryPage() {
    const supabase = createServerSupabaseClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) redirect("/login")

    const { data: rawBooks } = await supabase
        .from("books")
        .select(`
      id,
      user_id,
      title,
      author,
      cover_url,
      file_url,
      format,
      total_pages,
      created_at,
      reading_progress ( progress_percentage )
    `)
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })

    const books = (rawBooks || []).map((b: any) => ({
        id: b.id,
        user_id: b.user_id ?? user.id,
        title: b.title ?? "",
        author: b.author ?? "",
        cover_url: b.cover_url ?? null,
        file_url: b.file_url ?? null,
        format: b.format ?? "pdf",
        total_pages: b.total_pages ?? null,
        created_at: b.created_at ?? null,
        // reading_progress may be an array of relations: get first progress
        progress: Array.isArray(b.reading_progress) ? (b.reading_progress[0]?.progress_percentage ?? 0) : (b.reading_progress?.progress_percentage ?? 0),
    }))

    return <LibraryContent books={books} />
}


========== FILE: app\dashboard\notes\page.tsx ==========
// app/dashboard/notes/page.tsx
import { NotesList } from "@/components/features/notes/notes-list"
import { createServerSupabaseClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"

export default async function NotesPage() {
    const supabase = createServerSupabaseClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) redirect("/login")

    const { data: rawNotes } = await supabase
        .from("notes")
        .select("id, content, book_id, page, page_number, highlight_text, color, created_at, user_id")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })

    const notes = (rawNotes || []).map((n: any) => ({
        id: n.id,
        content: n.content ?? "",
        user_id: n.user_id ?? user.id,
        book_id: n.book_id ?? null,
        page_number: n.page_number ?? n.page ?? null,
        highlight_text: n.highlight_text ?? null,
        color: n.color ?? null,
        created_at: n.created_at,
    }))

    return <NotesList userId={user.id} notes={notes} />
}


========== FILE: app\dashboard\profile\loading.tsx ==========
import { Skeleton } from "@/components/ui/skeleton"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"

export default function ProfileLoading() {
    return (
        <div className="space-y-8 animate-pulse">
            {/* Profile Header Skeleton */}
            <div className="flex flex-col md:flex-row gap-8 items-start">
                <div className="flex-shrink-0">
                    <Skeleton className="h-32 w-32 rounded-full" />
                </div>
                <div className="flex-1 space-y-4 w-full">
                    <div className="space-y-2">
                        <Skeleton className="h-8 w-48" />
                        <Skeleton className="h-4 w-32" />
                    </div>
                    <div className="flex gap-4">
                        <Skeleton className="h-10 w-24" />
                        <Skeleton className="h-10 w-24" />
                    </div>
                </div>
            </div>

            {/* Stats Cards Skeleton */}
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                {[...Array(4)].map((_, i) => (
                    <Card key={i}>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                            <Skeleton className="h-4 w-24" />
                            <Skeleton className="h-4 w-4 rounded-full" />
                        </CardHeader>
                        <CardContent>
                            <Skeleton className="h-8 w-16 mb-2" />
                            <Skeleton className="h-3 w-32" />
                        </CardContent>
                    </Card>
                ))}
            </div>

            {/* Badges Skeleton */}
            <div className="space-y-4">
                <Skeleton className="h-8 w-32" />
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    {[...Array(6)].map((_, i) => (
                        <Skeleton key={i} className="aspect-square rounded-xl" />
                    ))}
                </div>
            </div>
        </div>
    )
}


========== FILE: app\dashboard\profile\page.tsx ==========
import { ProfileHeader } from "@/components/features/profile/profile-header"
import { ProfileTabs } from "@/components/features/profile/profile-tabs"
import { createServerSupabaseClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"

export const dynamic = 'force-dynamic'

export default async function ProfilePage() {
    const supabase = createServerSupabaseClient()
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
        redirect("/login")
    }

    // Fetch profile data
    const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single()

    // Fetch books read count
    const { count: booksRead } = await supabase
        .from('reading_progress')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.id)
        .eq('progress_percentage', 100)

    // Fetch total reading time
    const { data: sessions } = await supabase
        .from('reading_sessions')
        .select('duration_minutes')
        .eq('user_id', user.id)

    const totalMinutes = sessions?.reduce((acc: number, session: any) => acc + session.duration_minutes, 0) || 0

    const stats = {
        booksRead: booksRead || 0,
        streak: profile?.current_streak || 0,
        highestStreak: profile?.highest_streak || 0,
        totalMinutes: totalMinutes
    }

    // Combine auth user data with profile data
    const userData = {
        full_name: profile?.full_name || user.user_metadata?.full_name,
        email: user.email,
        avatar_url: profile?.avatar_url || user.user_metadata?.avatar_url,
        created_at: user.created_at
    }

    return (
        <div className="space-y-8 animate-in fade-in duration-500">
            <ProfileHeader user={userData} stats={stats} />
            <ProfileTabs />
        </div>
    )
}


========== FILE: app\dashboard\quotes\page.tsx ==========
// app/dashboard/quotes/page.tsx
import { QuotesList } from "@/components/features/quotes/quotes-list"
import { createServerSupabaseClient } from "@/lib/supabase/server"
import { redirect } from "next/navigation"

export default async function QuotesPage() {
    const supabase = createServerSupabaseClient()
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) redirect("/login")

    const { data: rawQuotes } = await supabase
        .from("book_quotes")
        .select(`
      id,
      quote_text,
      page_number,
      page_ref,
      chapter,
      note,
      is_favorite,
      created_at,
      books ( id, title, author )
    `)
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })

    const quotes = (rawQuotes || []).map((q: any) => ({
        id: q.id,
        quote_text: q.quote_text ?? "",
        page_number: q.page_number ?? q.page_ref ?? null,
        chapter: q.chapter ?? null,
        note: q.note ?? null,
        is_favorite: !!q.is_favorite,
        created_at: q.created_at,
        books: Array.isArray(q.books) ? q.books[0] ?? null : q.books ?? null
    }))

    return <QuotesList userId={user.id} quotes={quotes} />
}


========== FILE: app\dashboard\reader\[id]\page.tsx ==========

========== FILE: app\dashboard\server-debug\page.tsx ==========
import { createServerSupabaseClient } from "@/lib/supabase/server"
import { cookies, headers } from "next/headers"

export const dynamic = 'force-dynamic'

export default async function ServerDebugPage() {
    const cookieStore = cookies()
    const allCookies = cookieStore.getAll()

    const supabase = createServerSupabaseClient()
    const { data: { user }, error } = await supabase.auth.getUser()

    const headerStore = headers()
    const middlewareCookies = headerStore.get('x-middleware-cookies') || "MISSING HEADER"
    const envUrl = process.env.NEXT_PUBLIC_SUPABASE_URL ? "Set (Starts with " + process.env.NEXT_PUBLIC_SUPABASE_URL.substring(0, 8) + ")" : "MISSING!"

    return (
        <div className="p-8 bg-black min-h-screen text-green-400 font-mono text-sm space-y-6">
            <h1 className="text-2xl text-white font-bold">SERVER-SIDE DEBUG</h1>

            <section className="space-y-2 border border-purple-800 p-4 rounded bg-purple-950/20">
                <h2 className="text-xl text-white">0. Environment & Middleware Probe</h2>
                <div className="bg-gray-900 p-4 rounded space-y-2">
                    <div><strong>Supabase URL (Env):</strong> {envUrl}</div>
                    <div className="break-all"><strong>Cookies Seen by Middleware:</strong> <br />{middlewareCookies}</div>
                </div>
            </section>

            <section className="space-y-2 border border-blue-800 p-4 rounded bg-blue-950/20">
                <h2 className="text-xl text-white">1. Server Auth Status</h2>
                <div className="bg-gray-900 p-4 rounded">
                    <div><strong>User ID:</strong> {user?.id || "NULL"}</div>
                    <div><strong>Error:</strong> {error?.message || "None"}</div>
                </div>
            </section>

            <section className="space-y-2 border border-gray-800 p-4 rounded">
                <h2 className="text-xl text-white">2. Raw Cookies Received by Server</h2>
                <div className="bg-gray-900 p-4 rounded overflow-auto text-xs break-all max-h-96">
                    {allCookies.length === 0 ? "NO COOKIES RECEIVED" : (
                        <ul className="list-disc pl-4">
                            {allCookies.map(c => (
                                <li key={c.name} className="mb-2">
                                    <span className="text-yellow-400">{c.name}</span>
                                    <span className="text-gray-500 mx-2">=</span>
                                    <span className="text-gray-300">{c.value.substring(0, 20)}... ({c.value.length} chars)</span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            </section>
        </div>
    )
}


========== FILE: app\dashboard\settings\page.tsx ==========
// app/dashboard/settings/page.tsx
import { SettingsForm } from "@/components/features/settings/settings-form"
import { createServerSupabaseClient } from "@/lib/supabase/server"

export const dynamic = "force-dynamic"

export default async function SettingsPage() {
    const supabase = createServerSupabaseClient()
    const { data: sessionData } = await supabase.auth.getSession()
    const userId = sessionData.session?.user.id
    if (!userId) return null

    const { data: profile } = await supabase
        .from("profiles")
        .select("id, full_name, email, avatar_url, username")
        .eq("id", userId)
        .single()

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex items-center justify-between">
                <h2 className="text-3xl font-bold tracking-tight">Settings</h2>
            </div>
            <SettingsForm profile={profile ?? null} />
        </div>
    )
}


========== FILE: lib\supabase\client.ts ==========
// lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'

export function createBrowserSupabaseClient() {
    return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )
}


========== FILE: lib\supabase\fetch.ts ==========
// lib/supabase/server-fetch.ts
import { createServerSupabaseClient } from "./server";

export async function serverSupabaseRest(url: string, opts: RequestInit = {}) {
    const supabase = createServerSupabaseClient();
    // server components can use supabase.from() directly; this helper can be used for legacy REST calls
    const { data: { session } } = await supabase.auth.getSession();
    const token = session?.access_token;

    const res = await fetch(url, {
        ...opts,
        headers: {
            ...(opts.headers || {}),
            Authorization: token ? `Bearer ${token}` : "",
            apikey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
            "Content-Type": "application/json",
        },
    });

    return res;
}


========== FILE: lib\supabase\get-user.ts ==========
// lib/supabase/get-user.ts
import { createServerSupabaseClient } from './server'

export async function getUserFromServer() {
    const supabase = createServerSupabaseClient()
    const { data: { user } } = await supabase.auth.getUser()
    return user ?? null
}


========== FILE: lib\supabase\server.ts ==========
// lib/supabase/server.ts
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export function createServerSupabaseClient() {
    const cookieStore = cookies()
    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll()
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value, options }) =>
                        cookieStore.set(name, value, options)
                    )
                },
            },
        }
    )
}


========== FILE: components\features\auth-guard.tsx ==========
"use client"

import { useAuth } from "@/components/providers/auth-provider"
import { useRouter, usePathname } from "next/navigation"
import { useEffect } from "react"

export function AuthGuard({ children }: { children: React.ReactNode }) {
    const { user, loading } = useAuth()
    const router = useRouter()
    const pathname = usePathname()

    useEffect(() => {
        if (!loading && !user) {
            router.replace(`/login?next=${pathname}`)
        }
    }, [user, loading, router, pathname])

    if (loading) {
        return (
            <div className="flex h-screen w-full items-center justify-center">
                <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent" />
            </div>
        )
    }

    if (!user) {
        return null
    }

    return <>{children}</>
}


========== FILE: components\features\continue-reading.tsx ==========
"use client"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Progress } from "@/components/ui/progress"
import { PlayCircle, BookOpen } from "lucide-react"
import { useEffect, useState } from "react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import Link from "next/link"

interface ContinueReadingBook {
    id: string
    title: string
    author: string
    cover_url?: string
    current_page: number
    total_pages: number
    progress_percentage?: number
}

// Helper function to clean up book titles
function cleanTitle(title: string): string {
    return title
        .replace(/_/g, ' ') // Replace underscores with spaces
        .replace(/\.(pdf|epub|txt)$/i, '') // Remove file extensions
        .replace(/^.*?_/, '') // Remove prefix like "OceanofPDF.com_"
        .trim()
}

export function ContinueReading() {
    const [book, setBook] = useState<ContinueReadingBook | null>(null)
    const [loading, setLoading] = useState(true)

    useEffect(() => {
        const fetchLastReadBook = async () => {
            const supabase = createBrowserSupabaseClient()

            const { data: { user } } = await supabase.auth.getUser()
            if (!user) return

            // Get most recently updated book from reading_progress
            const { data } = await supabase
                .from('reading_progress')
                .select(`
                    current_page,
                    progress_percentage,
                    books (
                        id,
                        title,
                        author,
                        cover_url,
                        total_pages
                    )
                `)
                .eq('user_id', user.id)
                // Removed .gt('progress_percentage', 0) to show books even at start
                .lt('progress_percentage', 100)
                .order('updated_at', { ascending: false })
                .limit(1)
                .single()

            if (data && data.books) {
                const bookData = Array.isArray(data.books) ? data.books[0] : data.books
                setBook({
                    id: bookData.id,
                    title: bookData.title,
                    author: bookData.author,
                    cover_url: bookData.cover_url,
                    current_page: data.current_page,
                    total_pages: bookData.total_pages || 0,
                    progress_percentage: data.progress_percentage
                })
            }

            setLoading(false)
        }

        fetchLastReadBook()
    }, [])

    if (loading) {
        return (
            <Card className="col-span-1 md:col-span-2">
                <CardHeader>
                    <CardTitle>Continue Reading</CardTitle>
                </CardHeader>
                <CardContent className="flex items-center justify-center h-32">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </CardContent>
            </Card>
        )
    }

    if (!book) {
        return (
            <Card className="col-span-1 md:col-span-2">
                <CardHeader>
                    <CardTitle>Continue Reading</CardTitle>
                </CardHeader>
                <CardContent className="flex flex-col items-center justify-center h-32 text-muted-foreground">
                    <BookOpen className="h-12 w-12 mb-2 opacity-50" />
                    <p className="text-sm">No books in progress. Start reading to see your progress here!</p>
                </CardContent>
            </Card>
        )
    }

    const progress = book.progress_percentage || (book.total_pages > 0 ? Math.round((book.current_page / book.total_pages) * 100) : 0)
    const isGradient = book.cover_url?.startsWith('gradient:')
    const gradientStyle = isGradient ? book.cover_url?.replace('gradient:', '') : null

    return (
        <Card className="col-span-1 md:col-span-2">
            <CardHeader>
                <CardTitle>Continue Reading</CardTitle>
            </CardHeader>
            <CardContent className="flex gap-4">
                <div className="h-32 w-24 rounded-md flex-shrink-0 overflow-hidden shadow-sm">
                    {isGradient ? (
                        <div
                            className="w-full h-full flex items-center justify-center text-white"
                            style={{ background: gradientStyle || '' }}
                        >
                            <BookOpen className="h-8 w-8 opacity-80" />
                        </div>
                    ) : book.cover_url ? (
                        <img src={book.cover_url} alt={book.title} className="w-full h-full object-cover" />
                    ) : (
                        <div className="w-full h-full bg-muted flex items-center justify-center">
                            <BookOpen className="h-8 w-8 text-muted-foreground" />
                        </div>
                    )}
                </div>
                <div className="flex flex-col justify-between flex-1">
                    <div>
                        <h3 className="text-lg font-semibold line-clamp-2">{cleanTitle(book.title)}</h3>
                        <p className="text-sm text-muted-foreground">{book.author}</p>
                    </div>
                    <div className="space-y-2">
                        <div className="flex justify-between text-sm">
                            <span>Page {book.current_page} of {book.total_pages}</span>
                            <span>{progress}%</span>
                        </div>
                        <Progress value={progress} className="h-2" />
                        <Link href={`/dashboard/reader/${book.id}`}>
                            <Button size="sm" className="w-fit gap-2 mt-2">
                                <PlayCircle className="h-4 w-4" /> Continue
                            </Button>
                        </Link>
                    </div>
                </div>
            </CardContent>
        </Card>
    )
}


========== FILE: components\features\dashboard-charts.tsx ==========
"use client"

import { useEffect, useState } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Bar, BarChart, ResponsiveContainer, XAxis, YAxis, Tooltip } from "recharts"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { format, subDays, startOfDay, endOfDay } from "date-fns"

export function DashboardCharts() {
    const [data, setData] = useState<{ name: string; minutes: number }[]>([])
    const [loading, setLoading] = useState(true)

    useEffect(() => {
        const fetchData = async () => {
            const supabase = createBrowserSupabaseClient()

            const { data: { user } } = await supabase.auth.getUser()
            if (!user) return

            // Get last 7 days range
            const today = new Date()
            const lastWeek = subDays(today, 6) // Last 7 days including today

            const { data: sessions } = await supabase
                .from('reading_sessions')
                .select('duration_minutes, session_date')
                .eq('user_id', user.id)
                .gte('session_date', format(lastWeek, 'yyyy-MM-dd'))
                .lte('session_date', format(today, 'yyyy-MM-dd'))

            // Initialize chart data with 0s for last 7 days
            const chartData = []
            for (let i = 6; i >= 0; i--) {
                const date = subDays(today, i)
                const dateStr = format(date, 'yyyy-MM-dd')
                const dayName = format(date, 'EEE') // Mon, Tue, etc.

                // Sum minutes for this day
                const minutes = sessions
                    ?.filter(s => s.session_date === dateStr)
                    .reduce((acc, s) => acc + s.duration_minutes, 0) || 0

                chartData.push({
                    name: dayName,
                    minutes: minutes
                })
            }

            setData(chartData)
            setLoading(false)
        }

        fetchData()
    }, [])

    const CustomTooltip = ({ active, payload }: any) => {
        if (active && payload && payload.length) {
            return (
                <div className="bg-popover border border-border rounded-lg shadow-lg p-3">
                    <p className="text-sm font-medium">{payload[0].payload.name}</p>
                    <p className="text-sm text-primary font-bold">{payload[0].value} minutes</p>
                </div>
            )
        }
        return null
    }

    if (loading) {
        return (
            <Card className="col-span-4 h-[430px] animate-pulse">
                <CardHeader>
                    <div className="h-6 w-48 bg-muted rounded"></div>
                </CardHeader>
                <CardContent>
                    <div className="h-[350px] bg-muted/20 rounded"></div>
                </CardContent>
            </Card>
        )
    }

    return (
        <Card className="col-span-4 w-full">
            <CardHeader>
                <CardTitle>Weekly Reading Activity</CardTitle>
            </CardHeader>
            <CardContent className="pl-2">
                <ResponsiveContainer width="100%" height={350} minHeight={300}>
                    <BarChart data={data}>
                        <XAxis
                            dataKey="name"
                            stroke="hsl(var(--muted-foreground))"
                            fontSize={12}
                            tickLine={false}
                            axisLine={false}
                        />
                        <YAxis
                            stroke="hsl(var(--muted-foreground))"
                            fontSize={12}
                            tickLine={false}
                            axisLine={false}
                            tickFormatter={(value) => `${value}m`}
                        />
                        <Tooltip content={<CustomTooltip />} cursor={{ fill: 'hsl(var(--muted))' }} />
                        <Bar dataKey="minutes" fill="hsl(var(--primary))" radius={[8, 8, 0, 0]} />
                    </BarChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>
    )
}


========== FILE: components\features\dashboard-header.tsx ==========
"use client"

import { Button } from "@/components/ui/button"
import { UserCircle, Menu } from "lucide-react"
import { ThemeToggle } from "@/components/ui/theme-toggle"
import Link from "next/link"
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet"
import { DashboardSidebar } from "@/components/features/dashboard-sidebar"

export function DashboardHeader() {
    return (
        <div className="flex items-center gap-2 p-4 border-b h-16 justify-between lg:justify-end">
            {/* Mobile Sidebar Trigger */}
            <div className="md:hidden">
                <Sheet>
                    <SheetTrigger asChild>
                        <Button variant="ghost" size="icon">
                            <Menu className="h-6 w-6" />
                        </Button>
                    </SheetTrigger>
                    <SheetContent side="left" className="p-0 border-r-0">
                        <DashboardSidebar />
                    </SheetContent>
                </Sheet>
            </div>

            <div className="flex items-center gap-2">
                <ThemeToggle />
                <Link href="/dashboard/profile">
                    <Button variant="ghost" size="icon">
                        <UserCircle className="h-6 w-6" />
                    </Button>
                </Link>
            </div>
        </div>
    )
}


========== FILE: components\features\dashboard-sidebar.tsx ==========
"use client"

import Link from "next/link"
import { usePathname } from "next/navigation"
import { cn } from "@/lib/utils"
import { Home, Library, BookOpen, Bookmark, StickyNote, Quote, Users, Settings, LogOut, UserCircle } from "lucide-react"

export function DashboardSidebar() {
    const pathname = usePathname()

    const routes = [
        {
            label: "Dashboard",
            icon: Home,
            href: "/dashboard",
        },
        {
            label: "Library",
            icon: Library,
            href: "/dashboard/library",
        },
        {
            label: "Bookmarks",
            icon: Bookmark,
            href: "/dashboard/bookmarks",
        },
        {
            label: "Notes",
            icon: StickyNote,
            href: "/dashboard/notes",
        },
        {
            label: "Quotes",
            icon: Quote,
            href: "/dashboard/quotes",
        },
        {
            label: "Community",
            icon: Users,
            href: "/dashboard/community",
        },
        {
            label: "Profile",
            icon: UserCircle,
            href: "/dashboard/profile",
        },
        {
            label: "Settings",
            icon: Settings,
            href: "/dashboard/settings",
        },
    ]

    return (
        <div className="space-y-4 py-4 flex flex-col h-full bg-card border-r transition-colors duration-300">
            <div className="px-3 py-2 flex-1">
                <Link href="/dashboard" className="flex items-center pl-3 mb-14">
                    <BookOpen className="h-8 w-8 text-primary mr-2" />
                    <h1 className="text-2xl font-bold">Trove</h1>
                </Link>
                <div className="space-y-1">
                    {routes.map((route) => (
                        <Link
                            key={route.href}
                            href={route.href}
                            className={cn(
                                "text-sm group flex p-3 w-full justify-start font-medium cursor-pointer hover:text-primary hover:bg-primary/10 rounded-lg transition-all duration-200",
                                pathname === route.href ? "text-primary bg-primary/10" : "text-muted-foreground"
                            )}
                        >
                            <div className="flex items-center flex-1">
                                <route.icon className={cn("h-5 w-5 mr-3", pathname === route.href ? "text-primary" : "text-muted-foreground")} />
                                {route.label}
                            </div>
                        </Link>
                    ))}
                </div>
            </div>
            <div className="px-3 py-2">
                <Link
                    href="/api/auth/signout"
                    className="text-sm group flex p-3 w-full justify-start font-medium cursor-pointer text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-950/20 rounded-lg transition-all duration-200"
                >
                    <div className="flex items-center flex-1">
                        <LogOut className="h-5 w-5 mr-3" />
                        Sign Out
                    </div>
                </Link>
            </div>
        </div>
    )
}


========== FILE: components\features\dashboard-stats.tsx ==========
"use client"

import { useEffect, useState } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Flame, Clock, BookOpen, TrendingUp } from "lucide-react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { format } from "date-fns"

export function DashboardStats() {
    const [stats, setStats] = useState({
        streak: 0,
        totalMinutes: 0,
        booksRead: 0,
        dailyGoal: 30,
        todayMinutes: 0,
        readingNow: 0
    })
    const [loading, setLoading] = useState(true)

    useEffect(() => {
        const fetchStats = async () => {
            const supabase = createBrowserSupabaseClient()

            const { data: { user } } = await supabase.auth.getUser()
            if (!user) return

            // Fetch all data in parallel for better performance
            const [profileData, progressData, sessionsData] = await Promise.all([
                // Fetch profile for streak and goal
                supabase
                    .from('profiles')
                    .select('current_streak, daily_goal_minutes')
                    .eq('id', user.id)
                    .single(),

                // Fetch reading progress stats
                supabase
                    .from('reading_progress')
                    .select('progress_percentage', { count: 'exact' })
                    .eq('user_id', user.id),

                // Fetch all reading sessions
                supabase
                    .from('reading_sessions')
                    .select('duration_minutes, session_date')
                    .eq('user_id', user.id)
            ])

            // Calculate books read
            const booksRead = progressData.data?.filter(p => p.progress_percentage === 100).length || 0

            // Calculate books currently reading
            const readingNow = progressData.data?.filter(
                p => p.progress_percentage < 100
            ).length || 0

            // Calculate total and today's minutes
            const totalMinutes = sessionsData.data?.reduce((acc, session) => acc + session.duration_minutes, 0) || 0

            const todayLocal = format(new Date(), 'yyyy-MM-dd')

            const todayMinutes = sessionsData.data
                ?.filter(session => session.session_date === todayLocal)
                .reduce((acc, session) => acc + session.duration_minutes, 0) || 0

            setStats({
                streak: profileData.data?.current_streak || 0,
                totalMinutes,
                booksRead,
                dailyGoal: profileData.data?.daily_goal_minutes || 30,
                todayMinutes,
                readingNow
            })

            setLoading(false)
        }

        fetchStats()
    }, [])

    if (loading) {
        return (
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                {[...Array(4)].map((_, i) => (
                    <Card key={i} className="animate-pulse">
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                            <div className="h-4 w-24 bg-muted rounded"></div>
                            <div className="h-4 w-4 bg-muted rounded"></div>
                        </CardHeader>
                        <CardContent>
                            <div className="h-8 w-16 bg-muted rounded mb-2"></div>
                            <div className="h-3 w-32 bg-muted rounded"></div>
                        </CardContent>
                    </Card>
                ))}
            </div>
        )
    }

    return (
        <div className="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5">
            <Card className="bg-card/50 backdrop-blur-sm border-orange-500/20 shadow-lg shadow-orange-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Current Streak</CardTitle>
                    <div className="p-2 bg-orange-500/10 rounded-full">
                        <Flame className="h-4 w-4 text-orange-500" />
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="text-3xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">
                        {stats.streak} Days
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">Keep the flame alive!</p>
                </CardContent>
            </Card>

            <Card className="bg-card/50 backdrop-blur-sm border-blue-500/20 shadow-lg shadow-blue-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Today's Minutes</CardTitle>
                    <div className="p-2 bg-blue-500/10 rounded-full">
                        <Clock className="h-4 w-4 text-blue-500" />
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="text-3xl font-bold bg-gradient-to-r from-blue-500 to-cyan-500 bg-clip-text text-transparent">
                        {stats.todayMinutes}
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">Minutes read today</p>
                </CardContent>
            </Card>

            <Card className="bg-card/50 backdrop-blur-sm border-green-500/20 shadow-lg shadow-green-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Books Read</CardTitle>
                    <div className="p-2 bg-green-500/10 rounded-full">
                        <BookOpen className="h-4 w-4 text-green-500" />
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="text-3xl font-bold bg-gradient-to-r from-green-500 to-emerald-500 bg-clip-text text-transparent">
                        {stats.booksRead}
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">Total completed books</p>
                </CardContent>
            </Card>

            <Card className="bg-card/50 backdrop-blur-sm border-purple-500/20 shadow-lg shadow-purple-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Daily Goal</CardTitle>
                    <div className="p-2 bg-purple-500/10 rounded-full">
                        <TrendingUp className="h-4 w-4 text-purple-500" />
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="text-3xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent">
                        {Math.round((stats.todayMinutes / stats.dailyGoal) * 100)}%
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">{stats.todayMinutes}/{stats.dailyGoal} minutes</p>
                </CardContent>
            </Card>

            <Card className="bg-card/50 backdrop-blur-sm border-indigo-500/20 shadow-lg shadow-indigo-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                    <CardTitle className="text-sm font-medium">Reading Now</CardTitle>
                    <div className="p-2 bg-indigo-500/10 rounded-full">
                        <BookOpen className="h-4 w-4 text-indigo-500" />
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="text-3xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 bg-clip-text text-transparent">
                        {stats.readingNow}
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">Active books</p>
                </CardContent>
            </Card>
        </div>
    )
}


========== FILE: components\features\delete-confirm-dialog.tsx ==========
"use client"

import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import { Checkbox } from "@/components/ui/checkbox"
import { Label } from "@/components/ui/label"
import { useState } from "react"

interface DeleteConfirmDialogProps {
    open: boolean
    onOpenChange: (open: boolean) => void
    onConfirm: () => void
    title: string
    description: string
    storageKey: string // Key to store "don't ask again" preference
}

export function DeleteConfirmDialog({
    open,
    onOpenChange,
    onConfirm,
    title,
    description,
    storageKey,
}: DeleteConfirmDialogProps) {
    const [dontAskAgain, setDontAskAgain] = useState(false)

    const handleConfirm = () => {
        if (dontAskAgain) {
            localStorage.setItem(storageKey, "true")
        }
        onConfirm()
        onOpenChange(false)
    }

    return (
        <AlertDialog open={open} onOpenChange={onOpenChange}>
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>{title}</AlertDialogTitle>
                    <AlertDialogDescription>
                        {description}
                    </AlertDialogDescription>
                </AlertDialogHeader>

                <div className="flex items-center space-x-2 py-2">
                    <Checkbox
                        id="dont-ask"
                        checked={dontAskAgain}
                        onCheckedChange={(c) => setDontAskAgain(!!c)}
                    />
                    <Label htmlFor="dont-ask" className="text-sm text-muted-foreground font-normal cursor-pointer">
                        Don't ask me again
                    </Label>
                </div>

                <AlertDialogFooter>
                    <AlertDialogCancel onClick={() => setDontAskAgain(false)}>Cancel</AlertDialogCancel>
                    <AlertDialogAction
                        onClick={handleConfirm}
                        className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                    >
                        Delete
                    </AlertDialogAction>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    )
}


========== FILE: components\features\landing-cta.tsx ==========
"use client"

import { Button } from "@/components/ui/button"
import Link from "next/link"

export function LandingCTA() {
    return (
        <section className="py-20 px-6 text-center">
            <div className="max-w-3xl mx-auto space-y-6">
                <h2 className="text-3xl md:text-4xl font-bold tracking-tight">
                    Ready to transform your reading life?
                </h2>
                <p className="text-lg text-muted-foreground">
                    Join thousands of readers who are building better habits with Trove.
                </p>
                <Link href="/signup">
                    <Button size="lg" className="mt-4">
                        Get Started for Free
                    </Button>
                </Link>
            </div>
        </section>
    )
}


========== FILE: components\features\landing-features.tsx ==========
"use client"

import { motion } from "framer-motion"
import { Upload, BarChart3, Highlighter, Users, BookOpen, Clock } from "lucide-react"

const features = [
    {
        icon: Upload,
        title: "Upload Your Library",
        description: "Bring your own books. Support for PDF, EPUB, and TXT formats.",
        gradient: "from-blue-500 to-cyan-500",
    },
    {
        icon: BarChart3,
        title: "Detailed Analytics",
        description: "Visualize your reading habits with daily, weekly, and monthly charts.",
        gradient: "from-purple-500 to-pink-500",
    },
    {
        icon: Highlighter,
        title: "Notes & Highlights",
        description: "Mark important passages and keep your thoughts organized per book.",
        gradient: "from-amber-500 to-orange-500",
    },
    {
        icon: Clock,
        title: "Track Progress",
        description: "Automatically track reading time, pages read, and build your streak.",
        gradient: "from-green-500 to-emerald-500",
    },
    {
        icon: Users,
        title: "Join Communities",
        description: "Discuss books with like-minded readers in focused groups.",
        gradient: "from-rose-500 to-red-500",
    },
    {
        icon: BookOpen,
        title: "Distraction-Free Reader",
        description: "A clean, customizable reading experience designed for focus.",
        gradient: "from-indigo-500 to-purple-500",
    },
]

export function LandingFeatures() {
    return (
        <section id="features" className="py-20 bg-gradient-to-b from-background to-muted/20">
            <div className="container mx-auto px-6">
                <div className="text-center mb-16">
                    <h2 className="text-3xl font-bold tracking-tight mb-4">Everything you need to read better</h2>
                    <p className="text-muted-foreground max-w-2xl mx-auto">
                        Trove gives you the tools to manage your library, track your habits, and engage with your books.
                    </p>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {features.map((feature, index) => (
                        <motion.div
                            key={index}
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            viewport={{ once: true }}
                            transition={{ delay: index * 0.1, duration: 0.5 }}
                            whileHover={{ y: -8, transition: { duration: 0.2 } }}
                            className="group relative bg-card p-6 rounded-xl border shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden"
                        >
                            {/* Gradient background on hover */}
                            <div className={`absolute inset-0 bg-gradient-to-br ${feature.gradient} opacity-0 group-hover:opacity-5 transition-opacity duration-300`} />

                            {/* Icon with gradient */}
                            <div className={`relative mb-4 w-12 h-12 rounded-lg bg-gradient-to-br ${feature.gradient} p-2.5 group-hover:scale-110 transition-transform duration-300`}>
                                <feature.icon className="h-full w-full text-white" />
                            </div>

                            <h3 className="text-xl font-semibold mb-2 relative">{feature.title}</h3>
                            <p className="text-muted-foreground relative">{feature.description}</p>
                        </motion.div>
                    ))}
                </div>
            </div>
        </section>
    )
}


========== FILE: components\features\landing-footer.tsx ==========
export function LandingFooter() {
    return (
        <footer className="py-8 border-t bg-muted/20">
            <div className="container mx-auto px-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <p className="text-sm text-muted-foreground">
                    Â© {new Date().getFullYear()} Trove. All rights reserved.
                </p>
                <div className="flex gap-6 text-sm text-muted-foreground">
                    <a href="#" className="hover:text-foreground transition-colors">Privacy</a>
                    <a href="#" className="hover:text-foreground transition-colors">Terms</a>
                    <a href="#" className="hover:text-foreground transition-colors">Contact</a>
                </div>
            </div>
        </footer>
    )
}


========== FILE: components\features\landing-hero.tsx ==========
"use client"

import { Button } from "@/components/ui/button"
import { motion } from "framer-motion"
import Link from "next/link"
import { ArrowRight } from "lucide-react"

export function LandingHero() {
    return (
        <section className="py-20 md:py-32 px-6 flex flex-col items-center text-center overflow-hidden relative">
            <div className="absolute inset-0 -z-10 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-primary/10 via-background to-background opacity-50" />

            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.5 }}
                className="max-w-3xl space-y-6"
            >
                <h1 className="text-4xl md:text-6xl font-extrabold tracking-tight">
                    Your Personal <span className="text-primary">Reading Companion</span>
                </h1>
                <p className="text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto">
                    Track your reading progress, take insightful notes, and build a lasting reading habit.
                    Upload your own e-books and read anywhere.
                </p>
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4 pt-4">
                    <Link href="/signup">
                        <Button size="lg" className="gap-2">
                            Start Reading Now <ArrowRight className="h-4 w-4" />
                        </Button>
                    </Link>
                    <Link href="#features">
                        <Button variant="outline" size="lg">
                            Learn More
                        </Button>
                    </Link>
                </div>
            </motion.div>
        </section>
    )
}


========== FILE: components\features\landing-navbar.tsx ==========
"use client"

import Link from "next/link"
import { Button } from "@/components/ui/button"
import { BookOpen, Loader2 } from "lucide-react"
import { ThemeToggle } from "@/components/ui/theme-toggle"
import { useAuth } from "@/components/providers/auth-provider"

export function LandingNavbar() {
    const { user, loading } = useAuth()

    return (
        <nav className="flex items-center justify-between px-6 py-4 border-b bg-background/80 backdrop-blur-sm sticky top-0 z-50">
            <div className="flex items-center gap-2">
                <BookOpen className="h-6 w-6 text-primary" />
                <span className="text-xl font-bold tracking-tight">Trove</span>
            </div>
            <div className="flex items-center gap-2">
                <ThemeToggle />
                {loading ? (
                    <Button variant="ghost" disabled>
                        <Loader2 className="h-4 w-4 animate-spin" />
                    </Button>
                ) : user ? (
                    <Link href="/dashboard">
                        <Button>Dashboard</Button>
                    </Link>
                ) : (
                    <>
                        <Link href="/login">
                            <Button variant="ghost">Sign In</Button>
                        </Link>
                        <Link href="/signup">
                            <Button>Get Started</Button>
                        </Link>
                    </>
                )}
            </div>
        </nav>
    )
}


========== FILE: components\features\quick-actions.tsx ==========
"use client"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Upload, Library, Highlighter } from "lucide-react"
import Link from "next/link"

export function QuickActions() {
    return (
        <Card>
            <CardHeader>
                <CardTitle>Quick Actions</CardTitle>
            </CardHeader>
            <CardContent className="grid gap-2">
                <Button variant="outline" className="justify-start gap-2" asChild>
                    <Link href="/dashboard/library?upload=true">
                        <Upload className="h-4 w-4" /> Upload Book
                    </Link>
                </Button>
                <Button variant="outline" className="justify-start gap-2" asChild>
                    <Link href="/dashboard/library">
                        <Library className="h-4 w-4" /> Open Library
                    </Link>
                </Button>
                <Button variant="outline" className="justify-start gap-2" asChild>
                    <Link href="/dashboard/notes">
                        <Highlighter className="h-4 w-4" /> View Notes
                    </Link>
                </Button>
            </CardContent>
        </Card>
    )
}


========== FILE: components\features\share-invite-modal.tsx ==========
"use client"

import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Share2, Copy, Mail, MessageCircle, Check } from "lucide-react"
import { toast } from "sonner"

export function ShareInviteModal() {
    const [copied, setCopied] = useState(false)
    const [email, setEmail] = useState("")
    const [sending, setSending] = useState(false)
    const [inviteLink, setInviteLink] = useState("https://trove.app/invite/abc123")

    useEffect(() => {
        setInviteLink(`${window.location.origin}/invite/abc123`)
    }, [])

    const copyToClipboard = () => {
        navigator.clipboard.writeText(inviteLink)
        setCopied(true)
        setTimeout(() => setCopied(false), 2000)
    }

    const shareViaWhatsApp = () => {
        const message = encodeURIComponent(`Join me on Trove - the best reading companion app! ðŸ“š\n\n${inviteLink}`)
        window.open(`https://wa.me/?text=${message}`, '_blank')
    }

    const shareViaEmail = () => {
        const subject = encodeURIComponent("Join me on Trove!")
        const body = encodeURIComponent(`Hi!\n\nI've been using Trove to track my reading and I think you'd love it too!\n\nTrove is a reading companion app that helps you:\n- Track your reading progress\n- Take notes and highlights\n- View your reading analytics\n- Join book communities\n\nJoin me here: ${inviteLink}\n\nHappy reading! ðŸ“š`)
        window.open(`mailto:?subject=${subject}&body=${body}`, '_blank')
    }

    const sendEmailInvite = async () => {
        if (!email) return

        setSending(true)
        await new Promise(resolve => setTimeout(resolve, 1000))
        setSending(false)
        setEmail("")
        toast.success(`Invitation sent to ${email}!`)
    }

    return (
        <Dialog>
            <DialogTrigger asChild>
                <Button variant="outline" className="gap-2">
                    <Share2 className="h-4 w-4" /> Share & Invite
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-md">
                <DialogHeader>
                    <DialogTitle>Share Trove with Friends</DialogTitle>
                    <DialogDescription>
                        Invite your friends to join Trove and discover amazing books together!
                    </DialogDescription>
                </DialogHeader>
                <div className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="link">Your Invite Link</Label>
                        <div className="flex gap-2">
                            <Input
                                id="link"
                                value={inviteLink}
                                readOnly
                                className="flex-1"
                            />
                            <Button size="icon" variant="outline" onClick={copyToClipboard}>
                                {copied ? <Check className="h-4 w-4 text-green-500" /> : <Copy className="h-4 w-4" />}
                            </Button>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label>Quick Share</Label>
                        <div className="grid grid-cols-2 gap-2">
                            <Button variant="outline" className="gap-2" onClick={shareViaEmail}>
                                <Mail className="h-4 w-4" /> Email
                            </Button>
                            <Button variant="outline" className="gap-2" onClick={shareViaWhatsApp}>
                                <MessageCircle className="h-4 w-4" /> WhatsApp
                            </Button>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="email">Invite by Email</Label>
                        <div className="flex gap-2">
                            <Input
                                id="email"
                                type="email"
                                placeholder="friend@example.com"
                                className="flex-1"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                            />
                            <Button onClick={sendEmailInvite} disabled={!email || sending}>
                                {sending ? "Sending..." : "Send"}
                            </Button>
                        </div>
                    </div>
                </div>
                <DialogFooter className="sm:justify-start">
                    <p className="text-xs text-muted-foreground">
                        Share your love of reading! Friends who join get a special welcome bonus.
                    </p>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}


========== FILE: components\features\analytics\analytics-charts.tsx ==========
"use client"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Bar, BarChart, ResponsiveContainer, XAxis, YAxis, Tooltip, PieChart, Pie, Cell, LineChart, Line } from "recharts"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useEffect, useState } from "react"
import { format, subDays } from "date-fns"

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042'];

export function AnalyticsCharts({ readingProgress, userId }: { readingProgress?: any[], userId?: string }) {
    const [dailyData, setDailyData] = useState<{ name: string; minutes: number }[]>([])
    const [formatChartData, setFormatChartData] = useState<{ name: string; value: number }[]>([])
    const [trendData, setTrendData] = useState<{ name: string; minutes: number }[]>([])
    const [loading, setLoading] = useState(true)


    const supabase = createBrowserSupabaseClient()

    useEffect(() => {
        const fetchData = async () => {
            try {
                // If userId provided, get data client-side if needed, otherwise readingProgress (server) will be used
                let uid = userId
                if (!uid) {
                    const { data: { user } } = await supabase.auth.getUser()
                    uid = user?.id
                    if (!uid) {
                        setLoading(false)
                        return
                    }
                }

                // 1. Daily data (server may have passed readingProgress; fallback to client)
                const today = new Date()
                const lastWeek = subDays(today, 6)

                const { data: sessions } = await supabase
                    .from('reading_sessions')
                    .select('duration_minutes, session_date')
                    .eq('user_id', uid)
                    .gte('session_date', format(lastWeek, 'yyyy-MM-dd'))
                    .lte('session_date', format(today, 'yyyy-MM-dd'))

                const chartData = []
                for (let i = 6; i >= 0; i--) {
                    const date = subDays(today, i)
                    const dateStr = format(date, 'yyyy-MM-dd')
                    const dayName = format(date, 'EEE')
                    const minutes = (sessions || []).filter((s: any) => s.session_date === dateStr).reduce((acc: number, s: any) => acc + s.duration_minutes, 0)
                    chartData.push({ name: dayName, minutes })
                }
                setDailyData(chartData)

                // 2. Format data
                const { data: books } = await supabase.from('books').select('format').eq('user_id', uid)
                const formatCounts: Record<string, number> = {};
                (books || []).forEach((book: any) => {
                    const fmt = (book.format || 'pdf').toUpperCase()
                    formatCounts[fmt] = (formatCounts[fmt] || 0) + 1
                })
                const formatChartDataArray = Object.entries(formatCounts).map(([name, value]) => ({ name, value }))
                if (formatChartDataArray.length === 0) formatChartDataArray.push({ name: "No Books", value: 1 })
                setFormatChartData(formatChartDataArray)

                // 3. monthly trend
                const lastMonth = subDays(today, 28)
                const { data: monthSessions } = await supabase.from('reading_sessions').select('duration_minutes, session_date').eq('user_id', uid).gte('session_date', format(lastMonth, 'yyyy-MM-dd'))

                setTrendData([
                    { name: "3 Weeks Ago", minutes: getWeeklyMinutes(monthSessions, 3) },
                    { name: "2 Weeks Ago", minutes: getWeeklyMinutes(monthSessions, 2) },
                    { name: "Last Week", minutes: getWeeklyMinutes(monthSessions, 1) },
                    { name: "This Week", minutes: getWeeklyMinutes(monthSessions, 0) },
                ])

            } catch (err) {
                console.error("Analytics fetch failed", err)
            } finally {
                setLoading(false)
            }
        }

        fetchData()
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [userId])

    const getWeeklyMinutes = (sessions: any[] | null, weeksAgo: number) => {
        const today = new Date()
        const endDay = subDays(today, weeksAgo * 7)
        const startDay = subDays(endDay, 6)
        const startStr = format(startDay, 'yyyy-MM-dd')
        const endStr = format(endDay, 'yyyy-MM-dd')
        return (sessions || []).filter((s: any) => s.session_date >= startStr && s.session_date <= endStr).reduce((acc: number, s: any) => acc + s.duration_minutes, 0)
    }

    if (loading) {
        return <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-2 animate-pulse">
            <Card className="h-[300px] bg-muted/20" />
            <Card className="h-[300px] bg-muted/20" />
            <Card className="h-[300px] bg-muted/20 col-span-2" />
        </div>
    }

    return (
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-2">
            <Card>
                <CardHeader><CardTitle>Daily Reading Time</CardTitle></CardHeader>
                <CardContent>
                    <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={dailyData}>
                            <XAxis dataKey="name" stroke="#888888" fontSize={12} tickLine={false} axisLine={false} />
                            <YAxis stroke="#888888" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `${value}m`} />
                            <Tooltip cursor={{ fill: 'transparent' }} />
                            <Bar dataKey="minutes" fill="hsl(var(--primary))" radius={[4, 4, 0, 0]} />
                        </BarChart>
                    </ResponsiveContainer>
                </CardContent>
            </Card>

            <Card>
                <CardHeader><CardTitle>Reading Formats</CardTitle></CardHeader>
                <CardContent>
                    <ResponsiveContainer width="100%" height={300}>
                        <PieChart>
                            <Pie data={formatChartData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                {formatChartData.map((entry, index) => <Cell key={index} fill={COLORS[index % COLORS.length]} />)}
                            </Pie>
                            <Tooltip />
                        </PieChart>
                    </ResponsiveContainer>
                    <div className="flex justify-center gap-4 text-sm text-muted-foreground mt-4">
                        {formatChartData.map((entry, index) => <div key={entry.name} className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[index % COLORS.length] }} />{entry.name}</div>)}
                    </div>
                </CardContent>
            </Card>

            <Card className="col-span-1 md:col-span-2">
                <CardHeader><CardTitle>Monthly Trend</CardTitle></CardHeader>
                <CardContent>
                    <ResponsiveContainer width="100%" height={300}>
                        <LineChart data={trendData}>
                            <XAxis dataKey="name" stroke="#888888" fontSize={12} tickLine={false} axisLine={false} />
                            <YAxis stroke="#888888" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `${value}m`} />
                            <Tooltip />
                            <Line type="monotone" dataKey="minutes" stroke="hsl(var(--primary))" strokeWidth={2} />
                        </LineChart>
                    </ResponsiveContainer>
                </CardContent>
            </Card>
        </div>
    )
}


========== FILE: components\features\analytics\reading-goals.tsx ==========
"use client"

import { useEffect, useState } from "react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useAuth } from "@/components/providers/auth-provider"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Progress } from "@/components/ui/progress"
import { Target, Trophy, TrendingUp, Edit2, Check } from "lucide-react"
import { toast } from "sonner"

interface ReadingGoal {
    id: string
    year: number
    target_books: number
    books_completed: number
}

export function ReadingGoals() {
    const { user } = useAuth()
    const [goal, setGoal] = useState<ReadingGoal | null>(null)
    const [loading, setLoading] = useState(true)
    const [editing, setEditing] = useState(false)
    const [newTarget, setNewTarget] = useState(12)

    const currentYear = new Date().getFullYear()

    useEffect(() => {
        if (!user) return
        fetchGoal()
    }, [user])

    const fetchGoal = async () => {
        if (!user) return

        const supabase = createBrowserSupabaseClient()

        // Fetch completed books count dynamically
        const { count: completedCount } = await supabase
            .from('reading_progress')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', user.id)
            .eq('progress_percentage', 100)

        // Fetch goal settings
        const { data } = await supabase
            .from('reading_goals')
            .select('*')
            .eq('user_id', user.id)
            .eq('year', currentYear)
            .single()

        if (data) {
            setGoal({
                ...data,
                books_completed: completedCount || 0
            })
            setNewTarget(data.target_books)
        } else {
            // Create default goal
            const { data: newGoal } = await supabase
                .from('reading_goals')
                .insert({
                    user_id: user.id,
                    year: currentYear,
                    target_books: 12
                })
                .select()
                .single()

            if (newGoal) {
                setGoal({
                    ...newGoal,
                    books_completed: completedCount || 0
                })
            }
        }

        setLoading(false)
    }

    const updateGoal = async () => {
        if (!user || !goal) return

        const supabase = createBrowserSupabaseClient()

        const { error } = await supabase
            .from('reading_goals')
            .update({ target_books: newTarget })
            .eq('id', goal.id)

        if (error) {
            toast.error("Failed to update goal")
        } else {
            setGoal({ ...goal, target_books: newTarget })
            setEditing(false)
            toast.success("Goal updated!")
        }
    }

    if (loading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Target className="h-5 w-5" />
                        {currentYear} Reading Goal
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="h-32 bg-muted animate-pulse rounded" />
                </CardContent>
            </Card>
        )
    }

    if (!goal) return null

    const progress = (goal.books_completed / goal.target_books) * 100
    const remaining = Math.max(0, goal.target_books - goal.books_completed)
    const isComplete = goal.books_completed >= goal.target_books

    return (
        <Card className={isComplete ? "border-green-500" : ""}>
            <CardHeader>
                <CardTitle className="flex items-center justify-between">
                    <span className="flex items-center gap-2">
                        <Target className="h-5 w-5" />
                        {currentYear} Reading Goal
                    </span>
                    {!editing && (
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => setEditing(true)}
                        >
                            <Edit2 className="h-4 w-4" />
                        </Button>
                    )}
                </CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
                {/* Progress Display */}
                <div className="text-center">
                    <div className="text-5xl font-bold mb-2">
                        {goal.books_completed}
                        <span className="text-2xl text-muted-foreground">/{goal.target_books}</span>
                    </div>
                    <p className="text-muted-foreground">
                        {isComplete ? (
                            <span className="text-green-600 dark:text-green-400 font-semibold flex items-center justify-center gap-2">
                                <Trophy className="h-4 w-4" />
                                Goal achieved! ðŸŽ‰
                            </span>
                        ) : (
                            `${remaining} ${remaining === 1 ? 'book' : 'books'} to go`
                        )}
                    </p>
                </div>

                {/* Progress Bar */}
                <div className="space-y-2">
                    <Progress value={Math.min(progress, 100)} className="h-3" />
                    <div className="flex justify-between text-sm text-muted-foreground">
                        <span>{Math.round(progress)}% complete</span>
                        {!isComplete && (
                            <span className="flex items-center gap-1">
                                <TrendingUp className="h-3 w-3" />
                                {(goal.target_books / 12).toFixed(1)}/month
                            </span>
                        )}
                    </div>
                </div>

                {/* Edit Goal */}
                {editing && (
                    <div className="flex gap-2 items-center p-4 bg-muted rounded-lg">
                        <label className="text-sm font-medium whitespace-nowrap">
                            Target books:
                        </label>
                        <Input
                            type="number"
                            min={1}
                            max={365}
                            value={newTarget}
                            onChange={(e) => setNewTarget(parseInt(e.target.value))}
                            className="max-w-24"
                        />
                        <Button
                            size="sm"
                            onClick={updateGoal}
                        >
                            <Check className="h-4 w-4 mr-1" />
                            Save
                        </Button>
                        <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => {
                                setEditing(false)
                                setNewTarget(goal.target_books)
                            }}
                        >
                            Cancel
                        </Button>
                    </div>
                )}

                {/* Motivation */}
                {!isComplete && (
                    <div className="text-center text-sm text-muted-foreground italic">
                        "The more that you read, the more things you will know." â€” Dr. Seuss
                    </div>
                )}
            </CardContent>
        </Card>
    )
}


========== FILE: components\features\analytics\reading-streak-calendar.tsx ==========
"use client"

import { useEffect, useState } from "react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useAuth } from "@/components/providers/auth-provider"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Flame } from "lucide-react"

interface ReadingDay {
    date: string
    minutes: number
}

export function ReadingStreakCalendar() {
    const { user } = useAuth()
    const [readingData, setReadingData] = useState<ReadingDay[]>([])
    const [loading, setLoading] = useState(true)

    useEffect(() => {
        if (!user) return

        const fetchReadingData = async () => {
            const supabase = createBrowserSupabaseClient()

            // Get last 365 days of reading sessions
            const oneYearAgo = new Date()
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1)

            const { data } = await supabase
                .from('reading_sessions')
                .select('session_date, duration_minutes')
                .eq('user_id', user.id)
                .gte('session_date', oneYearAgo.toISOString().split('T')[0])
                .order('session_date', { ascending: true })

            if (data) {
                // Aggregate minutes by date
                const dateMap = new Map<string, number>()
                data.forEach(session => {
                    const existing = dateMap.get(session.session_date) || 0
                    dateMap.set(session.session_date, existing + session.duration_minutes)
                })

                setReadingData(
                    Array.from(dateMap.entries()).map(([date, minutes]) => ({
                        date,
                        minutes
                    }))
                )
            }
            setLoading(false)
        }

        fetchReadingData()
    }, [user])

    // Generate calendar grid
    const generateCalendar = () => {
        const today = new Date()
        const startDate = new Date(today)
        startDate.setDate(today.getDate() - 364) // Show 365 days

        const weeks: ReadingDay[][] = []
        let currentWeek: ReadingDay[] = []

        // Start from the first day of the week containing startDate
        const firstDay = new Date(startDate)
        firstDay.setDate(startDate.getDate() - startDate.getDay())

        for (let i = 0; i < 371; i++) { // 53 weeks * 7 days
            const currentDate = new Date(firstDay)
            currentDate.setDate(firstDay.getDate() + i)

            const dateStr = currentDate.toISOString().split('T')[0]
            const dayData = readingData.find(d => d.date === dateStr)

            currentWeek.push({
                date: dateStr,
                minutes: dayData?.minutes || 0
            })

            if (currentWeek.length === 7) {
                weeks.push(currentWeek)
                currentWeek = []
            }
        }

        return weeks
    }

    const getIntensityColor = (minutes: number): string => {
        if (minutes === 0) return 'bg-muted'
        if (minutes < 15) return 'bg-emerald-200 dark:bg-emerald-900/40'
        if (minutes < 30) return 'bg-emerald-400 dark:bg-emerald-700/60'
        if (minutes < 60) return 'bg-emerald-600 dark:bg-emerald-500/80'
        return 'bg-emerald-700 dark:bg-emerald-400'
    }

    const formatDate = (dateStr: string) => {
        return new Date(dateStr).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        })
    }

    const weeks = generateCalendar()
    const totalDays = readingData.length
    const currentStreak = calculateCurrentStreak()
    const longestStreak = calculateLongestStreak()

    function calculateCurrentStreak(): number {
        if (readingData.length === 0) return 0

        let streak = 0
        const today = new Date()
        let currentDate = new Date(today)

        while (true) {
            const dateStr = currentDate.toISOString().split('T')[0]
            const hasReading = readingData.some(d => d.date === dateStr && d.minutes > 0)

            if (!hasReading) break

            streak++
            currentDate.setDate(currentDate.getDate() - 1)
        }

        return streak
    }

    function calculateLongestStreak(): number {
        if (readingData.length === 0) return 0

        const sortedData = [...readingData].sort((a, b) => a.date.localeCompare(b.date))
        let maxStreak = 0
        let currentStreak = 0
        let lastDate: Date | null = null

        sortedData.forEach(day => {
            if (day.minutes === 0) {
                currentStreak = 0
                lastDate = null
                return
            }

            const currentDate = new Date(day.date)

            if (lastDate) {
                const dayDiff = Math.floor((currentDate.getTime() - lastDate.getTime()) / (1000 * 60 * 60 * 24))
                if (dayDiff === 1) {
                    currentStreak++
                } else {
                    currentStreak = 1
                }
            } else {
                currentStreak = 1
            }

            maxStreak = Math.max(maxStreak, currentStreak)
            lastDate = currentDate
        })

        return maxStreak
    }

    if (loading) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <Flame className="h-5 w-5 text-orange-500" />
                        Reading Activity
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="h-32 bg-muted animate-pulse rounded" />
                </CardContent>
            </Card>
        )
    }

    return (
        <Card>
            <CardHeader>
                <CardTitle className="flex items-center gap-2">
                    <Flame className="h-5 w-5 text-orange-500" />
                    Reading Activity
                </CardTitle>
                <div className="flex gap-6 text-sm text-muted-foreground mt-2">
                    <div>
                        <span className="font-semibold text-foreground">{totalDays}</span> days active
                    </div>
                    <div>
                        <span className="font-semibold text-foreground">{currentStreak}</span> day current streak
                    </div>
                    <div>
                        <span className="font-semibold text-foreground">{longestStreak}</span> day longest streak
                    </div>
                </div>
            </CardHeader>
            <CardContent>
                <div className="overflow-x-auto pb-4">
                    <div className="inline-flex gap-1">
                        {weeks.map((week, weekIndex) => (
                            <div key={weekIndex} className="flex flex-col gap-1">
                                {week.map((day, dayIndex) => (
                                    <div
                                        key={day.date}
                                        className={`w-3 h-3 rounded-sm ${getIntensityColor(day.minutes)} hover:ring-2 hover:ring-primary transition-all cursor-pointer group relative`}
                                        title={`${formatDate(day.date)}: ${day.minutes} minutes`}
                                    >
                                        {/* Tooltip on hover */}
                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-popover text-popover-foreground text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                            {formatDate(day.date)}: {day.minutes} min
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                </div>

                {/* Legend */}
                <div className="flex items-center gap-2 text-xs text-muted-foreground mt-4">
                    <span>Less</span>
                    <div className="flex gap-1">
                        <div className="w-3 h-3 rounded-sm bg-muted" />
                        <div className="w-3 h-3 rounded-sm bg-emerald-200 dark:bg-emerald-900/40" />
                        <div className="w-3 h-3 rounded-sm bg-emerald-400 dark:bg-emerald-700/60" />
                        <div className="w-3 h-3 rounded-sm bg-emerald-600 dark:bg-emerald-500/80" />
                        <div className="w-3 h-3 rounded-sm bg-emerald-700 dark:bg-emerald-400" />
                    </div>
                    <span>More</span>
                </div>
            </CardContent>
        </Card>
    )
}


========== FILE: components\features\bookmarks\bookmarks-list.tsx ==========
"use client"

import { useEffect, useState } from "react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { Card, CardContent } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Bookmark, Trash2, BookOpen, Clock } from "lucide-react"
import Link from "next/link"
import { toast } from "sonner"

interface BookmarkData {
    id: string
    book_id: string
    page_number: number | null
    epub_cfi: string | null
    progress_percentage: number | null
    created_at: string
    note: string | null
    books: {
        id: string
        title: string
        author: string
        cover_url: string
        format: string
    }
}

export function BookmarksList({ userId, bookmarks: initialBookmarks }: { userId: string, bookmarks: BookmarkData[] }) {
    const [bookmarks, setBookmarks] = useState<BookmarkData[]>(initialBookmarks ?? [])
    const [loading, setLoading] = useState(false)
    const supabase = createBrowserSupabaseClient()

    useEffect(() => {
        // initialBookmarks passed from server; keep that
        setBookmarks(initialBookmarks ?? [])
    }, [initialBookmarks])

    const deleteBookmark = async (bookmarkId: string) => {
        setLoading(true)
        try {
            const { error } = await supabase
                .from('bookmarks')
                .delete()
                .eq('id', bookmarkId)

            if (error) {
                toast.error("Failed to delete bookmark")
            } else {
                toast.success("Bookmark removed")
                setBookmarks(prev => prev.filter(b => b.id !== bookmarkId))
            }
        } finally {
            setLoading(false)
        }
    }

    // Define the grouped bookmarks type
    type GroupedBookmarks = Record<string, {
        book: BookmarkData['books']
        bookmarks: BookmarkData[]
    }>

    // group with strong typing
    const groupedBookmarks = bookmarks.reduce<GroupedBookmarks>((acc, bookmark) => {
        const bookId = bookmark.book_id
        if (!acc[bookId]) {
            acc[bookId] = {
                book: bookmark.books ?? null,
                bookmarks: []
            }
        }
        acc[bookId].bookmarks.push(bookmark)
        return acc
    }, {})

    const formatLocation = (bookmark: BookmarkData) => {
        if (bookmark.page_number) return `Page ${bookmark.page_number}`
        if (bookmark.progress_percentage !== null) return `${bookmark.progress_percentage}% complete`
        return 'Unknown location'
    }

    const formatDate = (dateString: string) => {
        const date = new Date(dateString)
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    }

    const buildReaderUrl = (bookmark: BookmarkData) => {
        const baseUrl = `/dashboard/reader/${bookmark.book_id}`
        const params = new URLSearchParams()
        if (bookmark.page_number) params.set('page', bookmark.page_number.toString())
        else if (bookmark.epub_cfi) params.set('cfi', bookmark.epub_cfi)
        else if (bookmark.progress_percentage) params.set('progress', (bookmark.progress_percentage / 100).toString())
        return params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl
    }

    if (bookmarks.length === 0) {
        return (
            <Card>
                <CardContent className="flex flex-col items-center justify-center py-12 text-center">
                    <Bookmark className="h-12 w-12 text-muted-foreground mb-4" />
                    <h3 className="text-lg font-semibold mb-2">No bookmarks yet</h3>
                    <p className="text-muted-foreground mb-4">Bookmark pages while reading to quickly return to them later</p>
                    <Link href="/dashboard/library">
                        <Button><BookOpen className="h-4 w-4 mr-2" />Browse Library</Button>
                    </Link>
                </CardContent>
            </Card>
        )
    }

    return (
        <div className="space-y-6">
            {Object.entries(groupedBookmarks).map(([bookId, { book, bookmarks: bookBookmarks }]) => (
                <Card key={bookId}>
                    <CardContent className="p-6">
                        <div className="flex gap-4 mb-4 pb-4 border-b">
                            <div className="w-16 h-24 rounded overflow-hidden flex-shrink-0 bg-gradient-to-br from-purple-500 to-pink-500">
                                {book.cover_url && !book.cover_url.startsWith('gradient:') ? (
                                    <img src={book.cover_url} alt={book.title} className="w-full h-full object-cover" />
                                ) : <div className="w-full h-full flex items-center justify-center"><BookOpen className="h-8 w-8 text-white opacity-80" /></div>}
                            </div>
                            <div className="flex-1 min-w-0">
                                <h3 className="font-semibold text-lg line-clamp-2">{book.title}</h3>
                                <p className="text-sm text-muted-foreground truncate">{book.author}</p>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="text-xs bg-secondary px-2 py-1 rounded uppercase">{book.format}</span>
                                    <span className="text-xs text-muted-foreground">{bookBookmarks.length} bookmark{bookBookmarks.length !== 1 ? 's' : ''}</span>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-3">
                            {bookBookmarks.map((bookmark) => (
                                <div key={bookmark.id} className="flex items-center justify-between p-3 rounded-lg border bg-card hover:bg-accent/50 transition-colors">
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 mb-1">
                                            <Bookmark className="h-4 w-4 text-primary flex-shrink-0" />
                                            <span className="font-medium text-sm">{formatLocation(bookmark)}</span>
                                        </div>
                                        <div className="flex items-center gap-2 text-xs text-muted-foreground">
                                            <Clock className="h-3 w-3" />
                                            <span>Saved {formatDate(bookmark.created_at)}</span>
                                        </div>
                                        {bookmark.note && <p className="text-sm text-muted-foreground mt-2 italic">"{bookmark.note}"</p>}
                                    </div>
                                    <div className="flex items-center gap-2 ml-4">
                                        <Link href={buildReaderUrl(bookmark)}>
                                            <Button size="sm" variant="default"><BookOpen className="h-4 w-4 mr-2" />Read</Button>
                                        </Link>
                                        <Button size="sm" variant="ghost" onClick={() => deleteBookmark(bookmark.id)}><Trash2 className="h-4 w-4" /></Button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </CardContent>
                </Card>
            ))}
        </div>
    )
}


========== FILE: components\features\community\community-invite-modal.tsx ==========
"use client"

import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { UserPlus, Copy, Mail, MessageCircle, Check } from "lucide-react"
import { toast } from "sonner"

interface CommunityInviteModalProps {
    communityId: string
    communityName: string
}

export function CommunityInviteModal({ communityId, communityName }: CommunityInviteModalProps) {
    const [copied, setCopied] = useState(false)
    const [email, setEmail] = useState("")
    const [sending, setSending] = useState(false)
    const [inviteLink, setInviteLink] = useState(`https://trove.app/join/${communityId}`)

    useEffect(() => {
        setInviteLink(`${window.location.origin}/join/${communityId}`)
    }, [communityId])

    const copyToClipboard = () => {
        navigator.clipboard.writeText(inviteLink)
        setCopied(true)
        setTimeout(() => setCopied(false), 2000)
    }

    const shareViaWhatsApp = () => {
        const message = encodeURIComponent(`Join "${communityName}" on Trove! ðŸ“š\n\nLet's discuss books together:\n${inviteLink}`)
        window.open(`https://wa.me/?text=${message}`, '_blank')
    }

    const shareViaEmail = () => {
        const subject = encodeURIComponent(`Join "${communityName}" on Trove`)
        const body = encodeURIComponent(`Hi!\n\nI'd love for you to join our "${communityName}" community on Trove!\n\nTrove is a reading companion app where we can discuss books, share notes, and track our reading together.\n\nJoin the community here: ${inviteLink}\n\nIf you're not on Trove yet, you'll be able to sign up and join us right away!\n\nSee you there! ðŸ“š`)
        window.open(`mailto:?subject=${subject}&body=${body}`, '_blank')
    }

    const sendEmailInvite = async () => {
        if (!email) return

        setSending(true)
        await new Promise(resolve => setTimeout(resolve, 1000))
        setSending(false)
        setEmail("")
        toast.success(`Invitation to "${communityName}" sent to ${email}!`)
    }

    return (
        <Dialog>
            <DialogTrigger asChild>
                <Button variant="outline" size="sm" className="gap-2">
                    <UserPlus className="h-4 w-4" /> Invite
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-md">
                <DialogHeader>
                    <DialogTitle>Invite to {communityName}</DialogTitle>
                    <DialogDescription>
                        Invite friends to join this community. They'll be prompted to sign up if they're not on Trove yet!
                    </DialogDescription>
                </DialogHeader>
                <div className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="community-link">Community Invite Link</Label>
                        <div className="flex gap-2">
                            <Input
                                id="community-link"
                                value={inviteLink}
                                readOnly
                                className="flex-1"
                            />
                            <Button size="icon" variant="outline" onClick={copyToClipboard}>
                                {copied ? <Check className="h-4 w-4 text-green-500" /> : <Copy className="h-4 w-4" />}
                            </Button>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label>Quick Share</Label>
                        <div className="grid grid-cols-2 gap-2">
                            <Button variant="outline" className="gap-2" onClick={shareViaEmail}>
                                <Mail className="h-4 w-4" /> Email
                            </Button>
                            <Button variant="outline" className="gap-2" onClick={shareViaWhatsApp}>
                                <MessageCircle className="h-4 w-4" /> WhatsApp
                            </Button>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="invite-email">Invite by Email</Label>
                        <div className="flex gap-2">
                            <Input
                                id="invite-email"
                                type="email"
                                placeholder="friend@example.com"
                                className="flex-1"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                            />
                            <Button onClick={sendEmailInvite} disabled={!email || sending}>
                                {sending ? "Sending..." : "Send"}
                            </Button>
                        </div>
                    </div>
                </div>
                <DialogFooter className="sm:justify-start">
                    <p className="text-xs text-muted-foreground">
                        New users will be redirected to sign up, then automatically join this community!
                    </p>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}


========== FILE: components\features\community\community-list.tsx ==========
"use client"

import { useState, useEffect } from "react"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Users, MessageCircle, Search } from "lucide-react"
import { CommunityInviteModal } from "./community-invite-modal"
import Link from "next/link"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"

export function CommunityList({ communities: initialCommunities }: { communities?: any[] }) {
    const [searchQuery, setSearchQuery] = useState("")
    const [communities, setCommunities] = useState<any[]>(initialCommunities ?? [])
    const [loading, setLoading] = useState(!initialCommunities)

    useEffect(() => {
        if (initialCommunities) {
            setCommunities(initialCommunities)
            setLoading(false)
            return
        }
        let mounted = true
        const fetchCommunities = async () => {
            const supabase = createBrowserSupabaseClient()
            const { data, error } = await supabase.from('communities').select('*').order('member_count', { ascending: false })
            if (mounted) {
                if (data) setCommunities(data)
                if (error) console.error("Error fetching communities:", error)
                setLoading(false)
            }
        }
        fetchCommunities()
        return () => { mounted = false }
    }, [initialCommunities])

    const getIcon = (iconName: string) => {
        const icons: Record<string, any> = { BookOpen: undefined }
        return icons[iconName] || undefined
    }

    const filteredCommunities = communities.filter(community =>
        community.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        community.description.toLowerCase().includes(searchQuery.toLowerCase())
    )

    if (loading) {
        return <div className="h-64 flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>
    }

    return (
        <div className="space-y-4">
            <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input placeholder="Search communities..." className="pl-10" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
            </div>

            <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                {filteredCommunities.length > 0 ? filteredCommunities.map(community => (
                    <Card key={community.id} className="hover:shadow-lg transition-all hover:scale-[1.02]">
                        <CardHeader>
                            <div className="flex items-center gap-3 mb-2">
                                <div className={`p-3 rounded-lg ${community.bg_color || 'bg-muted'}`}>
                                    <Users className="h-6 w-6" />
                                </div>
                            </div>
                            <CardTitle>{community.name}</CardTitle>
                            <CardDescription>{community.description}</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="flex items-center justify-between text-sm text-muted-foreground">
                                <div className="flex items-center gap-1"><Users className="h-4 w-4" /><span>{(community.member_count || 0).toLocaleString()} members</span></div>
                                <div className="flex items-center gap-1"><MessageCircle className="h-4 w-4" /><span>{community.active_count || 0} active</span></div>
                            </div>
                            <div className="flex gap-2">
                                <Button className="flex-1" asChild>
                                    <Link href={community.discord_url || '#'} target="_blank" rel="noopener noreferrer">Join Discussion</Link>
                                </Button>
                                <CommunityInviteModal communityId={community.id} communityName={community.name} />
                            </div>
                        </CardContent>
                    </Card>
                )) : <div className="col-span-full text-center py-12"><p className="text-muted-foreground">No communities found matching "{searchQuery}"</p></div>}
            </div>
        </div>
    )
}


========== FILE: components\features\gamification\achievement-confetti.tsx ==========
"use client"

import { useEffect, useState } from "react"
import Confetti from "react-confetti"
import { useWindowSize } from "@/hooks/use-window-size"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { toast } from "sonner"
import { Trophy } from "lucide-react"
import Link from "next/link"

interface AchievementConfettiProps {
    duration?: number
}

export function AchievementConfetti({ duration = 5000 }: AchievementConfettiProps) {
    const { width, height } = useWindowSize()
    const [show, setShow] = useState(false)
    const [achievements, setAchievements] = useState<string[]>([])

    // Check for unnotified achievements
    useEffect(() => {
        const checkAchievements = async () => {
            const supabase = createBrowserSupabaseClient()

            const { data: { user } } = await supabase.auth.getUser()
            if (!user) return

            // Get session storage key for this user
            const sessionKey = `confetti_shown_${user.id}`
            const shownAchievements = JSON.parse(sessionStorage.getItem(sessionKey) || '[]')

            // 1. Get unnotified achievements
            const { data: newAchievements } = await supabase
                .from('user_achievements')
                .select('id, achievement_id, achievements(name, description)')
                .eq('user_id', user.id)
                .eq('notified', false)

            if (newAchievements && newAchievements.length > 0) {
                // Filter out achievements that have already been shown in this session
                const achievementsToShow = newAchievements.filter(
                    ua => !shownAchievements.includes(ua.id)
                )

                if (achievementsToShow.length > 0) {
                    setShow(true)
                    const names = achievementsToShow.map((ua: any) => ua.achievements?.name || "New Achievement")
                    setAchievements(names)

                    // Show toast notification for each achievement
                    achievementsToShow.forEach((ua: any) => {
                        toast.success(
                            <div className="flex items-start gap-3">
                                <Trophy className="h-5 w-5 text-yellow-500 flex-shrink-0 mt-0.5" />
                                <div className="flex-1">
                                    <div className="font-semibold">Achievement Unlocked!</div>
                                    <div className="text-sm opacity-90">{ua.achievements?.name || "New Achievement"}</div>
                                </div>
                            </div>,
                            {
                                duration: 6000,
                                action: {
                                    label: "View Profile",
                                    onClick: () => window.location.href = '/dashboard/profile'
                                }
                            }
                        )
                    })

                    // 2. Mark as notified in database
                    const ids = achievementsToShow.map(ua => ua.id)
                    await supabase
                        .from('user_achievements')
                        .update({ notified: true })
                        .in('id', ids)

                    // 3. Store in session storage to prevent re-showing
                    const updatedShown = [...shownAchievements, ...ids]
                    sessionStorage.setItem(sessionKey, JSON.stringify(updatedShown))
                }
            }
        }

        checkAchievements()
        // Check every 30 seconds for new achievements
        const interval = setInterval(checkAchievements, 30000)
        return () => clearInterval(interval)
    }, [])

    useEffect(() => {
        if (show) {
            const timer = setTimeout(() => setShow(false), duration)
            return () => clearTimeout(timer)
        }
    }, [show, duration])

    if (!show) return null

    return (
        <div className="fixed inset-0 pointer-events-none z-[100]">
            <Confetti
                width={width}
                height={height}
                numberOfPieces={200}
                recycle={false}
                gravity={0.2}
            />
        </div>
    )
}


========== FILE: components\features\gamification\daily-goal-celebration.tsx ==========
"use client"

import { useEffect, useState } from 'react'
import { useAuth } from '@/components/providers/auth-provider'
import { createBrowserSupabaseClient } from '@/lib/supabase/client'
import confetti from 'canvas-confetti'
import { Trophy } from 'lucide-react'

export function DailyGoalCelebration() {
    const { user } = useAuth()
    const [celebrated, setCelebrated] = useState(false)

    useEffect(() => {
        if (!user) return

        const checkDailyGoal = async () => {
            // Check if already celebrated today
            const todayKey = `dailyGoal_${new Date().toISOString().split('T')[0]}`
            if (sessionStorage.getItem(todayKey)) {
                return
            }

            const supabase = createBrowserSupabaseClient()

            // Get user's daily goal
            const { data: profile } = await supabase
                .from('profiles')
                .select('daily_goal_minutes')
                .eq('id', user.id)
                .single()

            if (!profile) return

            // Get today's reading time
            const today = new Date().toISOString().split('T')[0]
            const { data: sessions } = await supabase
                .from('reading_sessions')
                .select('duration_minutes')
                .eq('user_id', user.id)
                .eq('session_date', today)

            const todayMinutes = sessions?.reduce((sum, s) => sum + s.duration_minutes, 0) || 0

            // Check if goal is reached
            if (todayMinutes >= profile.daily_goal_minutes && !celebrated) {
                celebrate()
                sessionStorage.setItem(todayKey, 'true')
                setCelebrated(true)
            }
        }

        // Check immediately
        checkDailyGoal()

        // Check every 30 seconds
        const interval = setInterval(checkDailyGoal, 30000)

        return () => clearInterval(interval)
    }, [user, celebrated])

    const celebrate = () => {
        // Duolingo-style celebration
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#FFD700', '#FFA500', '#FF6347', '#9370DB']
        })

        // Show toast-style message
        const celebrationDiv = document.createElement('div')
        celebrationDiv.className = 'fixed top-20 left-1/2 -translate-x-1/2 z-50 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-full shadow-2xl animate-in slide-in-from-top-5 duration-500 flex items-center gap-3'
        celebrationDiv.innerHTML = `
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
            </svg>
            <div>
                <div class="font-bold text-lg">Daily Goal Achieved! ðŸŽ‰</div>
                <div class="text-sm opacity-90">Great job on your reading streak!</div>
            </div>
        `
        document.body.appendChild(celebrationDiv)

        // Remove after 5 seconds
        setTimeout(() => {
            celebrationDiv.style.animation = 'slide-out-to-top 0.5s ease-in-out'
            setTimeout(() => celebrationDiv.remove(), 500)
        }, 5000)
    }

    return null
}


========== FILE: components\features\gamification\level-progress.tsx ==========
"use client"

import { Progress } from "@/components/ui/progress"
import { Trophy, Star } from "lucide-react"

interface LevelProgressProps {
    level: number
    currentXP: number
    nextLevelXP: number
    levelTitle: string
}

export function LevelProgress({ level, currentXP, nextLevelXP, levelTitle }: LevelProgressProps) {
    // Calculate progress percentage
    // Assuming levels start at 0 XP for level 1 (simplified)
    // Real logic might need prev level threshold to calculate bar fill correctly if levels have gaps
    // For now simple percentage of current level requirement

    // Simple logic: XP towards next level
    // If Level 1 is 0-500, and user has 250, progress is 50%
    // If Level 2 is 500-1500 (1000 diff), and user has 1000 total (500 into lvl 2), progress is 50%

    // We need minXP for current level to do this accurately. Passed in or derived?
    // Let's rely on props for now, parent can calculate range.

    const progress = Math.min(100, Math.max(0, (currentXP / nextLevelXP) * 100))

    return (
        <div className="bg-card border rounded-xl p-4 shadow-sm relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-5">
                <Trophy className="h-24 w-24" />
            </div>

            <div className="flex justify-between items-center mb-2 relative z-10">
                <div>
                    <div className="text-xs text-muted-foreground font-medium uppercase tracking-wider mb-1">Current Level</div>
                    <div className="flex items-baseline gap-2">
                        <span className="text-3xl font-bold text-primary">{level}</span>
                        <span className="text-sm font-medium text-foreground/80">{levelTitle}</span>
                    </div>
                </div>
                <div className="text-right">
                    <div className="text-xs text-muted-foreground font-medium uppercase tracking-wider mb-1">Total XP</div>
                    <div className="text-xl font-bold flex items-center gap-1 justify-end">
                        <Star className="h-4 w-4 text-yellow-500 fill-yellow-500" />
                        {currentXP.toLocaleString()}
                    </div>
                </div>
            </div>

            <div className="space-y-1 relative z-10">
                <Progress value={progress} className="h-3 bg-muted" />
                <div className="flex justify-between text-xs text-muted-foreground">
                    <span>{currentXP} XP</span>
                    <span>{nextLevelXP} XP</span>
                </div>
            </div>
        </div>
    )
}


========== FILE: components\features\gamification\level-up-celebration.tsx ==========
"use client"

import { useEffect, useState } from 'react'
import { useAuth } from '@/components/providers/auth-provider'
import { createBrowserSupabaseClient } from '@/lib/supabase/client'
import confetti from 'canvas-confetti'
import { Sparkles } from 'lucide-react'

export function LevelUpCelebration() {
    const { user } = useAuth()
    const [lastLevel, setLastLevel] = useState<number | null>(null)

    useEffect(() => {
        if (!user) return

        const checkLevelUp = async () => {
            const supabase = createBrowserSupabaseClient()

            const { data: profile } = await supabase
                .from('profiles')
                .select('current_level')
                .eq('id', user.id)
                .single()

            if (!profile) return

            const currentLevel = profile.current_level

            // Check session storage for last celebrated level
            const sessionKey = `lastLevel_${user.id}`
            const storedLastLevel = sessionStorage.getItem(sessionKey)

            if (storedLastLevel) {
                const lastLevelNum = parseInt(storedLastLevel)

                // If level increased, celebrate!
                if (currentLevel > lastLevelNum) {
                    celebrate(currentLevel)
                    sessionStorage.setItem(sessionKey, currentLevel.toString())
                    setLastLevel(currentLevel)
                }
            } else {
                // First time - just store current level
                sessionStorage.setItem(sessionKey, currentLevel.toString())
                setLastLevel(currentLevel)
            }
        }

        checkLevelUp()

        // Check every 10 seconds
        const interval = setInterval(checkLevelUp, 10000)
        return () => clearInterval(interval)
    }, [user])

    const celebrate = (newLevel: number) => {
        // Epic confetti burst
        const duration = 4000
        const animationEnd = Date.now() + duration
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 }

        function randomInRange(min: number, max: number) {
            return Math.random() * (max - min) + min
        }

        const interval: any = setInterval(function () {
            const timeLeft = animationEnd - Date.now()

            if (timeLeft <= 0) {
                return clearInterval(interval)
            }

            const particleCount = 50 * (timeLeft / duration)

            confetti({
                ...defaults,
                particleCount,
                origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
            })
            confetti({
                ...defaults,
                particleCount,
                origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
            })
        }, 250)

        // Show celebration banner
        const celebrationDiv = document.createElement('div')
        celebrationDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[200] bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 text-white px-12 py-8 rounded-2xl shadow-2xl animate-in zoom-in-95 duration-700 text-center border-4 border-white/20'
        celebrationDiv.innerHTML = `
            <div class="flex flex-col items-center gap-4">
                <svg class="w-20 h-20 text-yellow-300 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                <div>
                    <div class="text-4xl font-bold mb-2">LEVEL UP!</div>
                    <div class="text-6xl font-black text-yellow-300 mb-2">${newLevel}</div>
                    <div class="text-lg opacity-90">You've reached a new level!</div>
                    <div class="text-sm opacity-75 mt-2">Keep reading to unlock more achievements</div>
                </div>
            </div>
        `
        document.body.appendChild(celebrationDiv)

        // Remove after 5 seconds
        setTimeout(() => {
            celebrationDiv.style.animation = 'zoom-out 0.5s ease-in-out'
            setTimeout(() => celebrationDiv.remove(), 500)
        }, 5000)
    }

    return null
}


========== FILE: components\features\library\book-grid.tsx ==========
"use client"

import { Card, CardContent, CardFooter } from "@/components/ui/card"
import { Progress } from "@/components/ui/progress"
import { BookOpen, Trash2 } from "lucide-react"
import Link from "next/link"
import Image from "next/image"
import { type BookWithProgress } from "@/types/database"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useRouter } from "next/navigation"
import { Button } from "@/components/ui/button"
import { toast } from "sonner"

interface BookGridProps {
    books: BookWithProgress[]
}

import { DeleteConfirmDialog } from "@/components/features/delete-confirm-dialog"
import { useState } from "react"

// ... imports remain same but ensuring no duplicates

export function BookGrid({ books }: BookGridProps) {
    const router = useRouter()
    const supabase = createBrowserSupabaseClient()

    const [deleteTarget, setDeleteTarget] = useState<{ id: string, title: string } | null>(null)

    const handleDeleteClick = (e: React.MouseEvent, bookId: string, title: string) => {
        e.preventDefault()
        e.stopPropagation()

        // Check preference
        const dontAsk = localStorage.getItem("trove-delete-book-dont-ask")
        if (dontAsk === "true") {
            performDelete(bookId)
        } else {
            setDeleteTarget({ id: bookId, title })
        }
    }

    const performDelete = async (bookId: string) => {
        try {
            const { error } = await supabase
                .from('books')
                .delete()
                .eq('id', bookId)

            if (error) throw error

            toast.success("Book deleted successfully")
            router.refresh()
        } catch (error: any) {
            console.error('Error deleting book:', error)
            toast.error("Failed to delete book: " + error.message)
        }
    }

    if (books.length === 0) {
        return (
            <div className="text-center py-12">
                <p className="text-muted-foreground">No books found. Upload one to get started!</p>
            </div>
        )
    }

    return (
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            {books.map((book) => {
                const isGradient = book.cover_url?.startsWith('gradient:')
                const gradientStyle = isGradient ? book.cover_url?.replace('gradient:', '') : null

                return (
                    <Link href={`/dashboard/reader/${book.id}`} key={book.id}>
                        <Card className="h-full hover:shadow-md transition-shadow cursor-pointer group relative">
                            <Button
                                variant="destructive"
                                size="icon"
                                className="absolute top-2 right-2 h-8 w-8 z-10 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm"
                                onClick={(e) => handleDeleteClick(e, book.id, book.title)}
                            >
                                <Trash2 className="h-4 w-4" />
                            </Button>
                            <CardContent className="p-4">
                                <div className="aspect-[2/3] rounded-md mb-4 flex items-center justify-center relative overflow-hidden shadow-sm">
                                    {isGradient ? (
                                        <div
                                            className="w-full h-full flex flex-col items-center justify-center p-4 text-white"
                                            style={{ background: gradientStyle || '' }}
                                        >
                                            <div className="text-center space-y-2">
                                                <BookOpen className="h-10 w-10 mx-auto opacity-90" />
                                                <p className="text-xs font-bold uppercase tracking-wider opacity-80">
                                                    {book.format}
                                                </p>
                                            </div>
                                            <div className="absolute inset-0 bg-black/20"></div>
                                        </div>
                                    ) : book.cover_url ? (
                                        <Image
                                            src={book.cover_url}
                                            alt={book.title}
                                            fill
                                            className="object-cover transition-transform hover:scale-105 duration-500"
                                            sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 20vw"
                                        />
                                    ) : (
                                        <div className="flex flex-col items-center justify-center text-muted-foreground/50 w-full h-full bg-secondary/30">
                                            <BookOpen className="h-12 w-12 mb-2" />
                                            <span className="text-xs uppercase font-bold tracking-wider opacity-70">
                                                {book.format}
                                            </span>
                                        </div>
                                    )}
                                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white font-medium pointer-events-none">
                                        Read Now
                                    </div>
                                </div>
                                <h3 className="font-semibold truncate" title={book.title}>{book.title}</h3>
                                <p className="text-sm text-muted-foreground truncate">{book.author}</p>
                            </CardContent>
                            <CardFooter className="p-4 pt-0 block">
                                <div className="flex justify-between text-xs text-muted-foreground mb-1">
                                    <span>{book.progress || 0}%</span>
                                    <span>{(book.progress ?? 0) > 0 ? 'In Progress' : 'Not Started'}</span>
                                </div>
                                <Progress value={book.progress || 0} className="h-1" />
                            </CardFooter>
                        </Card>
                    </Link>
                )
            })}
            {deleteTarget && (
                <DeleteConfirmDialog
                    open={!!deleteTarget}
                    onOpenChange={(open: boolean) => !open && setDeleteTarget(null)}
                    onConfirm={() => deleteTarget && performDelete(deleteTarget.id)}
                    title="Delete Book?"
                    description={`Are you sure you want to delete "${deleteTarget.title}"? This action cannot be undone.`}
                    storageKey="trove-delete-book-dont-ask"
                />
            )}
        </div>
    )
}


========== FILE: components\features\library\empty-library.tsx ==========
"use client"

import { BookOpen, Upload, Trophy, BarChart3 } from "lucide-react"
import { UploadModal } from "./upload-modal"
import { useState } from "react"
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"

export function EmptyLibrary() {
    const [uploadOpen, setUploadOpen] = useState(false)

    const steps = [
        {
            icon: Upload,
            title: "Upload Books",
            description: "Import your favorite PDF, EPUB, or TXT files."
        },
        {
            icon: BarChart3,
            title: "Track Progress",
            description: "Automatically save your page and reading time."
        },
        {
            icon: Trophy,
            title: "Earn Rewards",
            description: "Unlock achievements and level up as you read."
        }
    ]

    return (
        <div className="flex flex-col items-center justify-center py-12 px-4 animate-in fade-in duration-500">
            <div className="text-center mb-10 max-w-2xl">
                <div className="inline-flex items-center justify-center p-4 bg-primary/10 rounded-full mb-6 ring-8 ring-primary/5">
                    <BookOpen className="h-10 w-10 text-primary" />
                </div>
                <h2 className="text-3xl font-bold tracking-tight mb-3">Welcome to your Library</h2>
                <p className="text-muted-foreground text-lg">
                    Your personal reading sanctuary is ready. Let's get you valid started!
                </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 w-full max-w-4xl">
                {steps.map((step, i) => (
                    <Card key={i} className="p-6 flex flex-col items-center text-center hover:shadow-md transition-shadow bg-muted/30 border-muted">
                        <div className="h-12 w-12 rounded-xl bg-background shadow-sm flex items-center justify-center mb-4 text-primary">
                            <step.icon className="h-6 w-6" />
                        </div>
                        <h3 className="font-semibold mb-2">{step.title}</h3>
                        <p className="text-sm text-muted-foreground">{step.description}</p>
                    </Card>
                ))}
            </div>

            <Button
                size="lg"
                onClick={() => setUploadOpen(true)}
                className="h-12 px-8 text-base shadow-lg shadow-primary/20 transition-all hover:scale-105"
            >
                <Upload className="mr-2 h-5 w-5" />
                Upload Your First Book
            </Button>

            <UploadModal open={uploadOpen} onOpenChange={setUploadOpen} />
        </div>
    )
}


========== FILE: components\features\library\library-content.tsx ==========
"use client"

import { useState, useEffect } from "react"
import { BookGrid } from "./book-grid"
import { LibrarySearch } from "./library-search"
import { EmptyLibrary } from "./empty-library"
import type { BookWithProgress } from "@/types/database"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useAuth } from "@/components/providers/auth-provider"

interface LibraryContentProps {
    books: BookWithProgress[]
}

export function LibraryContent({ books: initialBooks }: LibraryContentProps) {
    const { user } = useAuth()
    const [books, setBooks] = useState<BookWithProgress[]>(initialBooks || [])
    const [filteredBooks, setFilteredBooks] = useState<BookWithProgress[]>(initialBooks || [])
    const [loading, setLoading] = useState(false)

    // Allow client refresh after uploads (keeps server-first default)
    useEffect(() => {
        const handleBookUploaded = () => {
            // fetch only if user is present
            if (!user) return
            (async () => {
                setLoading(true)
                try {
                    const supabase = createBrowserSupabaseClient()
                    const { data: booksData } = await supabase
                        .from('books')
                        .select(`
              id,
              user_id,
              title,
              author,
              cover_url,
              file_url,
              format,
              total_pages,
              created_at,
              reading_progress ( progress_percentage )
            `)
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false })

                    const transformedBooks = (booksData || []).map((book: any) => ({
                        ...book,
                        reading_progress: undefined,
                        progress: book.reading_progress?.[0]?.progress_percentage || 0
                    }))

                    setBooks(transformedBooks)
                    setFilteredBooks(transformedBooks)
                } catch (err) {
                    console.error("Library refresh failed", err)
                } finally {
                    setLoading(false)
                }
            })()
        }
        window.addEventListener('book-uploaded', handleBookUploaded)
        return () => window.removeEventListener('book-uploaded', handleBookUploaded)
    }, [user])

    if (loading) {
        return (
            <div className="flex h-64 items-center justify-center">
                <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent" />
            </div>
        )
    }

    if (!books || books.length === 0) {
        return <EmptyLibrary />
    }

    return (
        <div className="space-y-6">
            <LibrarySearch
                books={books}
                onFilteredChange={(filtered) => setFilteredBooks(filtered as BookWithProgress[])}
            />
            {filteredBooks.length === 0 ? (
                <div className="text-center py-12 border border-dashed rounded-lg">
                    <p className="text-lg text-muted-foreground mb-2">No books match your search</p>
                    <p className="text-sm text-muted-foreground">Try adjusting your filters</p>
                </div>
            ) : (
                <BookGrid books={filteredBooks} />
            )}
        </div>
    )
}


========== FILE: components\features\library\library-search.tsx ==========
"use client"

import { useState, useMemo, useEffect } from "react"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"
import { Search, SlidersHorizontal, X } from "lucide-react"
import type { Book } from "@/types/database"

interface LibrarySearchProps {
    books: Book[]
    onFilteredChange: (filtered: Book[]) => void
}

type SortOption = 'title-asc' | 'title-desc' | 'date-asc' | 'date-desc' | 'author-asc'
type FormatFilter = 'all' | 'pdf' | 'epub' | 'txt'

export function LibrarySearch({ books, onFilteredChange }: LibrarySearchProps) {
    const [searchQuery, setSearchQuery] = useState("")
    const [formatFilter, setFormatFilter] = useState<FormatFilter>("all")
    const [sortBy, setSortBy] = useState<SortOption>("date-desc")
    const [showFilters, setShowFilters] = useState(false)

    // Filter and sort books
    const filteredBooks = useMemo(() => {
        let result = [...books]

        // Search by title or author
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase()
            result = result.filter(book =>
                book.title.toLowerCase().includes(query) ||
                book.author.toLowerCase().includes(query)
            )
        }

        // Filter by format
        if (formatFilter !== "all") {
            result = result.filter(book => book.format === formatFilter)
        }

        // Sort
        result.sort((a, b) => {
            switch (sortBy) {
                case 'title-asc':
                    return a.title.localeCompare(b.title)
                case 'title-desc':
                    return b.title.localeCompare(a.title)
                case 'author-asc':
                    return a.author.localeCompare(b.author)
                case 'date-asc':
                    return new Date(a.created_at).getTime() - new Date(b.created_at).getTime()
                case 'date-desc':
                    return new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
                default:
                    return 0
            }
        })

        return result
    }, [books, searchQuery, formatFilter, sortBy])

    // Notify parent of changes
    // Notify parent of changes
    useEffect(() => {
        onFilteredChange(filteredBooks)
    }, [filteredBooks, onFilteredChange])

    const handleClearFilters = () => {
        setSearchQuery("")
        setFormatFilter("all")
        setSortBy("date-desc")
    }

    const hasActiveFilters = searchQuery !== "" || formatFilter !== "all" || sortBy !== "date-desc"

    return (
        <div className="space-y-4">
            {/* Search Bar */}
            <div className="flex gap-2">
                <div className="relative flex-1">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                    <Input
                        type="search"
                        placeholder="Search books by title or author..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="pl-9"
                    />
                    {searchQuery && (
                        <Button
                            variant="ghost"
                            size="icon"
                            className="absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7"
                            onClick={() => setSearchQuery("")}
                        >
                            <X className="h-4 w-4" />
                        </Button>
                    )}
                </div>
                <Button
                    variant={showFilters ? "default" : "outline"}
                    size="icon"
                    onClick={() => setShowFilters(!showFilters)}
                >
                    <SlidersHorizontal className="h-4 w-4" />
                </Button>
            </div>

            {/* Filters Panel */}
            {showFilters && (
                <div className="flex flex-wrap gap-3 p-4 bg-muted/50 rounded-lg border">
                    <div className="flex-1 min-w-[200px]">
                        <label className="text-sm font-medium mb-2 block">Format</label>
                        <Select value={formatFilter} onValueChange={(value: FormatFilter) => setFormatFilter(value)}>
                            <SelectTrigger>
                                <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="all">All Formats</SelectItem>
                                <SelectItem value="pdf">PDF</SelectItem>
                                <SelectItem value="epub">EPUB</SelectItem>
                                <SelectItem value="txt">TXT</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    <div className="flex-1 min-w-[200px]">
                        <label className="text-sm font-medium mb-2 block">Sort By</label>
                        <Select value={sortBy} onValueChange={(value: SortOption) => setSortBy(value)}>
                            <SelectTrigger>
                                <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="date-desc">Newest First</SelectItem>
                                <SelectItem value="date-asc">Oldest First</SelectItem>
                                <SelectItem value="title-asc">Title (A-Z)</SelectItem>
                                <SelectItem value="title-desc">Title (Z-A)</SelectItem>
                                <SelectItem value="author-asc">Author (A-Z)</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    {hasActiveFilters && (
                        <div className="flex items-end">
                            <Button variant="ghost" size="sm" onClick={handleClearFilters}>
                                <X className="h-4 w-4 mr-2" />
                                Clear Filters
                            </Button>
                        </div>
                    )}
                </div>
            )}

            {/* Results Count */}
            <div className="text-sm text-muted-foreground">
                {filteredBooks.length === books.length ? (
                    `Showing all ${books.length} ${books.length === 1 ? 'book' : 'books'}`
                ) : (
                    `Showing ${filteredBooks.length} of ${books.length} ${books.length === 1 ? 'book' : 'books'}`
                )}
            </div>
        </div>
    )
}


========== FILE: components\features\library\upload-modal.tsx ==========
"use client"

import { useState, useRef } from "react"
import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Upload, Loader2, FileText, Image as ImageIcon } from "lucide-react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useAuth } from "@/components/providers/auth-provider"
import { useRouter } from "next/navigation"
import { toast } from "sonner"

// Generate a beautiful gradient based on book title
function generateGradient(title: string): string {
    const gradients = [
        "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
        "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
        "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
        "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
        "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
        "linear-gradient(135deg, #30cfd0 0%, #330867 100%)",
        "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
        "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)",
    ]
    const hash = title.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)
    return gradients[hash % gradients.length]
}

interface UploadModalProps {
    open?: boolean
    onOpenChange?: (open: boolean) => void
}

export function UploadModal({ open: controlledOpen, onOpenChange }: UploadModalProps = {}) {
    const [file, setFile] = useState<File | null>(null)
    const [coverFile, setCoverFile] = useState<File | null>(null)
    const [uploading, setUploading] = useState(false)
    const [internalOpen, setInternalOpen] = useState(false)
    const [isDragging, setIsDragging] = useState(false)
    const fileInputRef = useRef<HTMLInputElement>(null)
    const coverInputRef = useRef<HTMLInputElement>(null)
    const { user } = useAuth()
    const router = useRouter()

    // Use controlled open state if provided, otherwise use internal state
    const open = controlledOpen !== undefined ? controlledOpen : internalOpen
    const setOpen = onOpenChange || setInternalOpen

    const supabase = createBrowserSupabaseClient()

    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            const selectedFile = e.target.files[0]
            const fileType = selectedFile.type
            const validTypes = ['application/pdf', 'application/epub+zip', 'text/plain']
            const fileExt = selectedFile.name.split('.').pop()?.toLowerCase()
            const validExts = ['pdf', 'epub', 'txt']

            // Check file type
            if (!validTypes.includes(fileType) && !validExts.includes(fileExt || '')) {
                toast.error("Invalid file type. Please upload a PDF, EPUB, or TXT file.")
                return
            }

            // Check file size (50MB limit)
            const maxSize = 50 * 1024 * 1024 // 50MB in bytes
            if (selectedFile.size > maxSize) {
                toast.error("File too large. Maximum size is 50MB.")
                return
            }

            setFile(selectedFile)
        }
    }

    const handleDragOver = (e: React.DragEvent) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(true)
    }

    const handleDragLeave = (e: React.DragEvent) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(false)
    }

    const handleDrop = (e: React.DragEvent) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(false)

        const droppedFile = e.dataTransfer.files[0]
        if (droppedFile) {
            const fileType = droppedFile.type
            const validTypes = ['application/pdf', 'application/epub+zip', 'text/plain']
            const fileExt = droppedFile.name.split('.').pop()?.toLowerCase()
            const validExts = ['pdf', 'epub', 'txt']

            // Check file type
            if (!validTypes.includes(fileType) && !validExts.includes(fileExt || '')) {
                toast.error("Invalid file type. Please upload a PDF, EPUB, or TXT file.")
                return
            }

            // Check file size (50MB limit)
            const maxSize = 50 * 1024 * 1024
            if (droppedFile.size > maxSize) {
                toast.error("File too large. Maximum size is 50MB.")
                return
            }

            setFile(droppedFile)
        }
    }

    const handleUpload = async () => {
        if (!file || !user) return

        setUploading(true)

        try {
            const fileExt = file.name.split('.').pop()?.toLowerCase()

            // 1. Upload book file to storage
            const filePath = `${user.id}/${Date.now()}_${file.name}`
            const { error: uploadError } = await supabase.storage
                .from('books')
                .upload(filePath, file)

            if (uploadError) {
                toast.error("Failed to upload file. Please try again.")
                console.error(uploadError)
                setUploading(false)
                return
            }

            // 2. Get public URL for the uploaded file
            const { data: { publicUrl } } = supabase.storage
                .from('books')
                .getPublicUrl(filePath)

            // 3. Upload cover image if provided, otherwise generate gradient
            let coverUrl = `gradient:${generateGradient(file.name)}`
            if (coverFile) {
                const coverPath = `${user.id}/covers/${Date.now()}_${coverFile.name}`
                const { error: coverError } = await supabase.storage
                    .from('books')
                    .upload(coverPath, coverFile)

                if (!coverError) {
                    const { data: { publicUrl: coverPublicUrl } } = supabase.storage
                        .from('books')
                        .getPublicUrl(coverPath)
                    coverUrl = coverPublicUrl
                }
            }

            // 4. Extract page count for PDFs
            let totalPages = 0
            if (fileExt === 'pdf') {
                try {
                    const arrayBuffer = await file.arrayBuffer()
                    const pdfJS = await import('pdfjs-dist')
                    pdfJS.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfJS.version}/build/pdf.worker.min.mjs`

                    const pdf = await pdfJS.getDocument({ data: arrayBuffer }).promise
                    totalPages = pdf.numPages
                } catch (error) {
                    console.error('Failed to extract PDF page count:', error)
                    // Continue with totalPages = 0 if extraction fails
                }
            }

            // 5. Clean up book title
            const bookTitle = file.name
                .replace(/\.(pdf|epub|txt)$/i, '')
                .replace(/_/g, ' ')
                .replace(/^.*?_/, '')
                .trim()

            // 6. Insert record into database
            const { data: insertedBook, error: dbError } = await supabase
                .from('books')
                .insert({
                    user_id: user.id,
                    title: bookTitle,
                    author: "Unknown Author",
                    file_url: publicUrl,
                    cover_url: coverUrl,
                    format: fileExt || 'pdf',
                    total_pages: totalPages
                })
                .select()
                .single()

            if (dbError) {
                toast.error("Failed to save book details. Please try again.")
                console.error('Database insert error:', dbError)
                setUploading(false)
                return
            }


            toast.success("Book uploaded successfully!")
            setFile(null)
            setCoverFile(null)
            setOpen(false)

            // Force refresh the library page
            router.refresh()

            // Dispatch event to notify listeners (like library page) to refetch
            if (typeof window !== 'undefined') {
                window.dispatchEvent(new Event('book-uploaded'))
            }

            // Dispatch event to notify listeners (like library page) to refetch
            window.dispatchEvent(new Event('book-uploaded'))

            // Small delay then navigate to ensure data is fresh
            setTimeout(() => {
                router.push('/dashboard/library')
            }, 100)
        } catch (error) {
            toast.error("An unexpected error occurred. Please try again.")
            console.error(error)
        } finally {
            setUploading(false)
        }
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button className="bg-primary hover:bg-primary/90 text-primary-foreground shadow-md transition-all duration-300 hover:scale-105">
                    <Upload className="h-4 w-4 mr-2" /> Upload Book
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[500px] border-none shadow-2xl bg-card/95 backdrop-blur-xl duration-500 animate-in fade-in zoom-in-95">
                <DialogHeader>
                    <DialogTitle className="text-2xl font-bold tracking-tight bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent">
                        Add to Library
                    </DialogTitle>
                    <DialogDescription className="text-muted-foreground/80">
                        Drag and drop your PDF, EPUB, or TXT files here.
                    </DialogDescription>
                </DialogHeader>

                <div className="grid gap-6 py-6">
                    {/* Book File Upload */}
                    <div
                        className={`
                            relative group border-2 border-dashed rounded-xl p-10 text-center transition-all duration-300 cursor-pointer overflow-hidden
                            ${isDragging
                                ? "border-primary bg-primary/10 scale-[1.02]"
                                : "border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/30"
                            }
                            ${file ? "border-green-500/50 bg-green-500/5" : ""}
                        `}
                        onClick={() => fileInputRef.current?.click()}
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                    >
                        {/* Background Pattern */}
                        <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(#000000_1px,transparent_1px)] [background-size:16px_16px] pointer-events-none" />

                        <div className="relative z-10 flex flex-col items-center justify-center gap-3">
                            {file ? (
                                <div className="animate-in fade-in zoom-in duration-300">
                                    <div className="h-16 w-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-2 mx-auto">
                                        <FileText className="h-8 w-8 text-green-600 dark:text-green-400" />
                                    </div>
                                    <p className="text-base font-semibold text-foreground">{file.name}</p>
                                    <p className="text-xs text-muted-foreground font-medium uppercase tracking-wider">
                                        {(file.size / 1024 / 1024).toFixed(2)} MB â€¢ {file.name.split('.').pop()?.toUpperCase()}
                                    </p>
                                </div>
                            ) : (
                                <div className="group-hover:-translate-y-1 transition-transform duration-300">
                                    <div className="h-16 w-16 bg-primary/5 rounded-full flex items-center justify-center mb-4 mx-auto group-hover:bg-primary/10 transition-colors">
                                        <Upload className="h-8 w-8 text-primary/60 group-hover:text-primary transition-colors duration-300" />
                                    </div>
                                    <p className="text-lg font-medium text-foreground">Click or drag to upload</p>
                                    <p className="text-sm text-muted-foreground mt-1">
                                        Supports PDF, EPUB, TXT (Max 50MB)
                                    </p>
                                </div>
                            )}
                        </div>
                        <input
                            type="file"
                            ref={fileInputRef}
                            className="hidden"
                            accept=".pdf,.epub,.txt"
                            onChange={handleFileSelect}
                        />
                    </div>

                    {/* Cover Image Upload (Optional) */}
                    <div className="space-y-3">
                        <label className="text-sm font-semibold flex items-center gap-2 text-foreground/80">
                            <ImageIcon className="h-4 w-4" /> Cover Image <span className="text-xs font-normal text-muted-foreground ml-auto">(Optional)</span>
                        </label>
                        <div
                            onClick={() => coverInputRef.current?.click()}
                            className="flex items-center gap-3 p-3 rounded-lg border border-input bg-background hover:bg-muted/50 transition-colors cursor-pointer group"
                        >
                            <div className="h-10 w-10 rounded-md bg-muted flex items-center justify-center group-hover:bg-muted-foreground/20 transition-colors">
                                {coverFile ? (
                                    <ImageIcon className="h-5 w-5 text-primary" />
                                ) : (
                                    <div className="h-full w-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-md" />
                                )}
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium truncate">
                                    {coverFile ? coverFile.name : "Select a cover image"}
                                </p>
                                <p className="text-xs text-muted-foreground">
                                    {coverFile ? "Click to change" : "or leave empty for auto-generated cover"}
                                </p>
                            </div>
                            <Button size="sm" variant="ghost" className="h-8">Browse</Button>
                        </div>
                        <Input
                            type="file"
                            ref={coverInputRef}
                            accept="image/*"
                            onChange={(e) => setCoverFile(e.target.files?.[0] || null)}
                            className="hidden"
                        />
                    </div>
                </div>

                <DialogFooter className="gap-3 sm:gap-0">
                    <Button
                        variant="ghost"
                        onClick={() => setOpen(false)}
                        className="hover:bg-muted"
                    >
                        Cancel
                    </Button>
                    <Button
                        onClick={handleUpload}
                        disabled={!file || uploading}
                        className="min-w-[120px] bg-primary text-primary-foreground shadow-lg shadow-primary/20"
                    >
                        {uploading ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Uploading...
                            </>
                        ) : (
                            "Upload Book"
                        )}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}


========== FILE: components\features\notes\create-note-modal.tsx ==========
"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Plus, Loader2 } from "lucide-react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useAuth } from "@/components/providers/auth-provider"
import { useRouter } from "next/navigation"
import { toast } from "sonner"
import { GamificationService } from "@/lib/gamification"

import type { Book } from "@/types/database"

export function CreateNoteModal() {
    const [open, setOpen] = useState(false)

    const handleOpenChange = (newOpen: boolean) => {
        setOpen(newOpen)
        if (newOpen) {
            fetchBooks()
        }
    }
    const [bookTitle, setBookTitle] = useState("")
    const [highlight, setHighlight] = useState("")
    const [note, setNote] = useState("")
    const [loading, setLoading] = useState(false)
    const { user } = useAuth()
    const router = useRouter()

    const supabase = createBrowserSupabaseClient()

    const [libraryBooks, setLibraryBooks] = useState<Pick<Book, 'id' | 'title'>[]>([])

    // Fetch library books for matching
    const fetchBooks = async () => {
        if (!user) return
        const { data } = await supabase
            .from('books')
            .select('id, title')
            .eq('user_id', user.id)

        if (data) setLibraryBooks(data)
    }

    const handleSubmit = async () => {
        if (!user || !bookTitle || !note) return

        setLoading(true)
        try {
            // Find book with flexible matching (ignore case and extra spaces)
            const targetTitle = bookTitle.trim().toLowerCase().replace(/\s+/g, ' ')

            const matchedBook = libraryBooks.find(b =>
                b.title.toLowerCase().trim().replace(/\s+/g, ' ') === targetTitle
            )

            const { error } = await supabase
                .from('notes')
                .insert({
                    user_id: user.id,
                    book_id: matchedBook ? matchedBook.id : null,
                    content: note,
                    highlight_text: highlight || null,
                })

            if (error) throw error

            setOpen(false)
            setBookTitle("")
            setHighlight("")
            setNote("")
            router.refresh()
            window.dispatchEvent(new Event('note-created'))
            toast.success(matchedBook ? "Note added to " + matchedBook.title : "General note created (Book not found in library)")
        } catch (error) {
            console.error('Note creation error:', error)
            const message = error instanceof Error ? error.message : 'Unknown error'
            toast.error(message)
        } finally {
            setLoading(false)
        }
    }

    return (
        <Dialog open={open} onOpenChange={handleOpenChange}>
            <DialogTrigger asChild>
                <Button className="gap-2">
                    <Plus className="h-4 w-4" /> Create Note
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[500px]">
                <DialogHeader>
                    <DialogTitle>Create Note</DialogTitle>
                    <DialogDescription>
                        Add a new note or highlight from your reading.
                    </DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                    <div className="space-y-2">
                        <Label htmlFor="book">Book Title</Label>
                        <Input
                            id="book"
                            placeholder="Enter book title..."
                            value={bookTitle}
                            onChange={(e) => setBookTitle(e.target.value)}
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="highlight">Highlight (Optional)</Label>
                        <Textarea
                            id="highlight"
                            placeholder="Paste the text you want to highlight..."
                            value={highlight}
                            onChange={(e) => setHighlight(e.target.value)}
                            rows={3}
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="note">Your Note</Label>
                        <Textarea
                            id="note"
                            placeholder="Write your thoughts..."
                            value={note}
                            onChange={(e) => setNote(e.target.value)}
                            rows={4}
                        />
                    </div>
                </div>
                <DialogFooter>
                    <Button onClick={handleSubmit} disabled={!bookTitle || !note || loading}>
                        {loading ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Creating...
                            </>
                        ) : (
                            "Create Note"
                        )}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}


========== FILE: components\features\notes\notes-list.tsx ==========
"use client"

import { Card, CardContent, CardHeader } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Search, BookOpen } from "lucide-react"
import { CreateNoteModal } from "./create-note-modal"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useEffect, useState } from "react"
import { Button } from "@/components/ui/button"
import { Trash2 } from "lucide-react"
import { toast } from "sonner"
import { DeleteConfirmDialog } from "@/components/features/delete-confirm-dialog"
import type { Note } from "@/types/database"

export function NotesList({ userId, notes: initialNotes }: { userId: string, notes: Note[] }) {
    const supabase = createBrowserSupabaseClient()
    const [notes, setNotes] = useState<Note[]>(initialNotes ?? [])
    const [loading, setLoading] = useState(false)
    const [deleteNoteId, setDeleteNoteId] = useState<string | null>(null)

    useEffect(() => {
        setNotes(initialNotes ?? [])
    }, [initialNotes])

    const handleDeleteClick = (noteId: string) => {
        const dontAsk = localStorage.getItem("trove-delete-note-dont-ask")
        if (dontAsk === "true") performDelete(noteId)
        else setDeleteNoteId(noteId)
    }

    const performDelete = async (noteId: string) => {
        try {
            const { error, count } = await supabase
                .from('notes')
                .delete({ count: 'exact' })
                .eq('id', noteId)

            if (error) throw error
            if (count === 0) throw new Error("Could not delete note. You might not have permission.")

            setNotes(prev => prev.filter(n => n.id !== noteId))
            toast.success("Note deleted")
        } catch (error) {
            console.error('Delete error:', error)
            toast.error("Failed to delete note")
        }
    }

    if (!notes || notes.length === 0) {
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between gap-4">
                    <div className="relative max-w-md flex-1">
                        <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                        <Input type="search" placeholder="Search notes..." className="pl-8" />
                    </div>
                    <CreateNoteModal />
                </div>
                <div className="text-center py-12 border rounded-lg bg-muted/20 border-dashed">
                    <BookOpen className="h-10 w-10 mx-auto text-muted-foreground mb-3" />
                    <h3 className="font-medium text-lg">No notes yet</h3>
                    <p className="text-sm text-muted-foreground mb-4">Create your first note to get started!</p>
                </div>
            </div>
        )
    }

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between gap-4">
                <div className="relative max-w-md flex-1">
                    <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input type="search" placeholder="Search notes..." className="pl-8" />
                </div>
                <CreateNoteModal />
            </div>

            <div className="grid gap-4">
                {notes.map((note) => (
                    <Card key={note.id} className="group relative hover:border-primary/50 transition-colors">
                        <Button variant="ghost" size="icon" className="absolute top-2 right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity" onClick={() => handleDeleteClick(note.id)}>
                            <Trash2 className="h-3 w-3 text-destructive" />
                        </Button>
                        <CardHeader className="pb-2">
                            <div className="flex justify-between items-start">
                                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                                    <BookOpen className="h-4 w-4" />
                                    {note.book_id ? "Book Note" : "General Note"}
                                </div>
                                <span className="text-xs text-muted-foreground">{new Date(note.created_at).toLocaleDateString()}</span>
                            </div>
                        </CardHeader>
                        <CardContent className="space-y-3">
                            <p className="text-sm">{note.content}</p>
                        </CardContent>
                    </Card>
                ))}
            </div>

            {deleteNoteId && (
                <DeleteConfirmDialog
                    open={!!deleteNoteId}
                    onOpenChange={(open: boolean) => !open && setDeleteNoteId(null)}
                    onConfirm={() => deleteNoteId && performDelete(deleteNoteId)}
                    title="Delete Note?"
                    description="Are you sure you want to delete this note? This action cannot be undone."
                    storageKey="trove-delete-note-dont-ask"
                />
            )}
        </div>
    )
}


========== FILE: components\features\profile\badges-list.tsx ==========
"use client"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Lock, Unlock } from "lucide-react"

interface BadgeItem {
    id: string
    name: string
    description: string
    icon: string
    unlocked: boolean
    color: string
}

const BADGES: BadgeItem[] = [
    {
        id: "novice",
        name: "Novice Reader",
        description: "Read your first book",
        icon: "ðŸ“š",
        unlocked: true,
        color: "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300"
    },
    {
        id: "streak-7",
        name: "Week Warrior",
        description: "Reach a 7-day reading streak",
        icon: "ðŸ”¥",
        unlocked: false,
        color: "bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300"
    },
    {
        id: "scholar",
        name: "Scholar",
        description: "Read 10 books",
        icon: "ðŸŽ“",
        unlocked: false,
        color: "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300"
    },
    {
        id: "social",
        name: "Social Butterfly",
        description: "Join 3 communities",
        icon: "ðŸ¦‹",
        unlocked: false,
        color: "bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-300"
    },
    {
        id: "critic",
        name: "The Critic",
        description: "Leave 5 notes",
        icon: "âœï¸",
        unlocked: false,
        color: "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300"
    },
    {
        id: "master",
        name: "Master Reader",
        description: "Read 50 books",
        icon: "ðŸ‘‘",
        unlocked: false,
        color: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300"
    }
]

export function BadgesList() {
    return (
        <Card>
            <CardHeader>
                <CardTitle>Achievements</CardTitle>
            </CardHeader>
            <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {BADGES.map((badge) => (
                        <div
                            key={badge.id}
                            className={`flex items-center gap-4 p-4 rounded-lg border transition-all ${badge.unlocked
                                    ? "bg-card border-border shadow-sm"
                                    : "bg-muted/50 border-transparent opacity-70 grayscale"
                                }`}
                        >
                            <div className={`h-12 w-12 rounded-full flex items-center justify-center text-2xl ${badge.unlocked ? badge.color : "bg-muted"}`}>
                                {badge.icon}
                            </div>
                            <div className="flex-1">
                                <div className="flex items-center justify-between">
                                    <h4 className="font-semibold text-sm">{badge.name}</h4>
                                    {badge.unlocked ? (
                                        <Unlock className="h-3 w-3 text-muted-foreground" />
                                    ) : (
                                        <Lock className="h-3 w-3 text-muted-foreground" />
                                    )}
                                </div>
                                <p className="text-xs text-muted-foreground mt-1">{badge.description}</p>
                            </div>
                        </div>
                    ))}
                </div>
            </CardContent>
        </Card>
    )
}


========== FILE: components\features\profile\profile-header.tsx ==========
"use client"

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { Badge } from "@/components/ui/badge"
import { Card, CardContent } from "@/components/ui/card"
import { CalendarDays, BookOpen, Flame, Award, Trophy } from "lucide-react"
import { format } from "date-fns"

interface ProfileHeaderProps {
    user: {
        full_name?: string
        email?: string
        avatar_url?: string
        created_at?: string
    }
    stats: {
        booksRead: number
        streak: number
        highestStreak: number
        totalMinutes: number
    }
}

export function ProfileHeader({ user, stats }: ProfileHeaderProps) {
    const joinDate = user.created_at ? format(new Date(user.created_at), "MMMM yyyy") : "Unknown"

    return (
        <div className="space-y-6">
            <div className="relative overflow-hidden rounded-3xl bg-gradient-to-r from-primary/10 via-purple-500/10 to-blue-500/10 border border-border/50 p-8">
                {/* Background decorative elements */}
                <div className="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-primary/5 rounded-full blur-3xl" />
                <div className="absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-purple-500/5 rounded-full blur-3xl" />

                <div className="relative flex flex-col md:flex-row items-center md:items-start gap-8">
                    <div className="relative group">
                        <div className="absolute -inset-1 bg-gradient-to-r from-primary to-purple-600 rounded-full opacity-70 blur group-hover:opacity-100 transition duration-1000 group-hover:duration-200" />
                        <Avatar className="h-32 w-32 border-4 border-background shadow-xl relative">
                            <AvatarImage src={user.avatar_url} alt={user.full_name} className="object-cover" />
                            <AvatarFallback className="text-4xl bg-background/50 backdrop-blur-xl text-primary font-bold">
                                {user.full_name?.[0]?.toUpperCase() || "U"}
                            </AvatarFallback>
                        </Avatar>
                        <div className="absolute bottom-0 right-0 translate-x-2 translate-y-2">
                            <Badge className="bg-gradient-to-r from-yellow-400 to-orange-500 border-none px-2 py-1 shadow-lg">
                                Lvl 1
                            </Badge>
                        </div>
                    </div>

                    <div className="flex-1 text-center md:text-left space-y-3 z-10">
                        <div>
                            <h1 className="text-4xl font-bold tracking-tight bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text text-transparent">
                                {user.full_name || "Reader"}
                            </h1>
                            <p className="text-lg text-muted-foreground font-medium">{user.email}</p>
                        </div>

                        <div className="flex flex-wrap items-center justify-center md:justify-start gap-3">
                            <Badge variant="secondary" className="px-3 py-1.5 gap-1.5 text-sm font-normal backdrop-blur-sm bg-background/50">
                                <CalendarDays className="h-4 w-4 text-blue-500" />
                                Member since {joinDate}
                            </Badge>
                            <Badge variant="secondary" className="px-3 py-1.5 gap-1.5 text-sm font-normal backdrop-blur-sm bg-background/50">
                                <Award className="h-4 w-4 text-purple-500" />
                                Scholar Rank
                            </Badge>
                        </div>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                <Card className="bg-card/50 backdrop-blur-sm border-blue-500/20 shadow-lg shadow-blue-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                    <CardContent className="flex flex-col items-center justify-center p-6 gap-3">
                        <div className="p-3 bg-blue-500/10 rounded-full">
                            <BookOpen className="h-6 w-6 text-blue-500" />
                        </div>
                        <div className="text-center">
                            <div className="text-3xl font-bold bg-gradient-to-r from-blue-500 to-cyan-500 bg-clip-text text-transparent">
                                {stats.booksRead}
                            </div>
                            <div className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mt-1">Books Read</div>
                        </div>
                    </CardContent>
                </Card>

                <Card className="bg-card/50 backdrop-blur-sm border-orange-500/20 shadow-lg shadow-orange-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                    <CardContent className="flex flex-col items-center justify-center p-6 gap-3">
                        <div className="p-3 bg-orange-500/10 rounded-full">
                            <Flame className="h-6 w-6 text-orange-500" />
                        </div>
                        <div className="text-center">
                            <div className="text-3xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">
                                {stats.streak}
                            </div>
                            <div className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mt-1">Day Streak</div>
                        </div>
                    </CardContent>
                </Card>

                <Card className="bg-card/50 backdrop-blur-sm border-yellow-500/20 shadow-lg shadow-yellow-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                    <CardContent className="flex flex-col items-center justify-center p-6 gap-3">
                        <div className="p-3 bg-yellow-500/10 rounded-full">
                            <Trophy className="h-6 w-6 text-yellow-500" />
                        </div>
                        <div className="text-center">
                            <div className="text-3xl font-bold bg-gradient-to-r from-yellow-500 to-amber-500 bg-clip-text text-transparent">
                                {stats.highestStreak}
                            </div>
                            <div className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mt-1">Best Streak</div>
                        </div>
                    </CardContent>
                </Card>

                <Card className="bg-card/50 backdrop-blur-sm border-purple-500/20 shadow-lg shadow-purple-500/5 transition-all duration-300 hover:scale-105 hover:bg-card/80">
                    <CardContent className="flex flex-col items-center justify-center p-6 gap-3">
                        <div className="p-3 bg-purple-500/10 rounded-full">
                            <Award className="h-6 w-6 text-purple-500" />
                        </div>
                        <div className="text-center">
                            <div className="text-3xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent">
                                {Math.floor(stats.totalMinutes / 60)}
                            </div>
                            <div className="text-xs font-semibold text-muted-foreground uppercase tracking-wider mt-1">Hours Read</div>
                        </div>
                    </CardContent>
                </Card>
            </div>
        </div>
    )
}


========== FILE: components\features\profile\profile-tabs.tsx ==========
"use client"

import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { BadgesList } from "./badges-list"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Clock } from "lucide-react"

export function ProfileTabs() {
    return (
        <Tabs defaultValue="overview" className="space-y-4">
            <TabsList>
                <TabsTrigger value="overview">Overview</TabsTrigger>
                <TabsTrigger value="badges">Badges & Achievements</TabsTrigger>
                <TabsTrigger value="history">Reading History</TabsTrigger>
            </TabsList>

            <TabsContent value="overview" className="space-y-4">
                <BadgesList />
            </TabsContent>

            <TabsContent value="badges">
                <BadgesList />
            </TabsContent>

            <TabsContent value="history">
                <Card>
                    <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                            <Clock className="h-5 w-5" />
                            Recent Activity
                        </CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="text-sm text-muted-foreground text-center py-8">
                            Reading history tracking coming soon.
                        </div>
                    </CardContent>
                </Card>
            </TabsContent>
        </Tabs>
    )
}


========== FILE: components\features\quotes\quotes-list.tsx ==========
"use client"

import { useEffect, useState } from "react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { Card } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Quote, Star, Trash2, BookOpen } from "lucide-react"
import { toast } from "sonner"
import Link from "next/link"

interface BookQuote {
    id: string
    quote_text: string
    page_number: number | null
    chapter: string | null
    note: string | null
    is_favorite: boolean
    created_at: string
    books: { id: string; title: string; author: string }
}

export function QuotesList({ userId, quotes: initialQuotes }: { userId: string, quotes: BookQuote[] }) {
    const [quotes, setQuotes] = useState<BookQuote[]>(initialQuotes ?? [])
    const [filter, setFilter] = useState<'all' | 'favorites'>('all')
    const supabase = createBrowserSupabaseClient()

    useEffect(() => {
        setQuotes(initialQuotes ?? [])
    }, [initialQuotes])

    const toggleFavorite = async (quoteId: string, currentFavorite: boolean) => {
        const { error } = await supabase
            .from('book_quotes')
            .update({ is_favorite: !currentFavorite })
            .eq('id', quoteId)

        if (error) toast.error("Failed to update favorite")
        else {
            setQuotes(prev => prev.map(q => q.id === quoteId ? { ...q, is_favorite: !currentFavorite } : q))
            toast.success(currentFavorite ? "Removed from favorites" : "Added to favorites")
        }
    }

    const deleteQuote = async (quoteId: string) => {
        const { error } = await supabase.from('book_quotes').delete().eq('id', quoteId)
        if (error) toast.error("Failed to delete quote")
        else {
            setQuotes(prev => prev.filter(q => q.id !== quoteId))
            toast.success("Quote deleted")
        }
    }

    const filteredQuotes = filter === 'favorites' ? quotes.filter(q => q.is_favorite) : quotes

    if (quotes.length === 0) {
        return (
            <Card className="p-12 text-center border-dashed">
                <Quote className="h-12 w-12 mx-auto mb-4 text-muted-foreground" />
                <h3 className="text-xl font-semibold mb-2">No Quotes Yet</h3>
                <p className="text-muted-foreground mb-6">Start saving your favorite quotes while reading</p>
                <Button asChild>
                    <Link href="/dashboard/library"><BookOpen className="h-4 w-4 mr-2" />Go to Library</Link>
                </Button>
            </Card>
        )
    }

    return (
        <div className="space-y-6">
            <div className="flex gap-2 border-b">
                <button onClick={() => setFilter('all')} className={`px-4 py-2 font-medium transition-colors border-b-2 ${filter === 'all' ? 'border-primary text-primary' : 'border-transparent text-muted-foreground hover:text-foreground'}`}>All Quotes ({quotes.length})</button>
                <button onClick={() => setFilter('favorites')} className={`px-4 py-2 font-medium transition-colors border-b-2 flex items-center gap-2 ${filter === 'favorites' ? 'border-primary text-primary' : 'border-transparent text-muted-foreground hover:text-foreground'}`}>
                    <Star className="h-4 w-4" /> Favorites ({quotes.filter(q => q.is_favorite).length})
                </button>
            </div>

            <div className="space-y-4">
                {filteredQuotes.map((quote) => (
                    <Card key={quote.id} className="p-6 hover:shadow-md transition-shadow">
                        <div className="flex items-start justify-between gap-4 mb-4">
                            <div className="flex-1">
                                <Link href={`/dashboard/reader/${quote.books.id}`} className="font-semibold hover:underline">{quote.books.title}</Link>
                                <p className="text-sm text-muted-foreground">by {quote.books.author}</p>
                            </div>
                            <div className="flex gap-2">
                                <Button variant="ghost" size="icon" onClick={() => toggleFavorite(quote.id, quote.is_favorite)}>
                                    <Star className={`h-4 w-4 ${quote.is_favorite ? 'fill-yellow-500 text-yellow-500' : 'text-muted-foreground'}`} />
                                </Button>
                                <Button variant="ghost" size="icon" onClick={() => deleteQuote(quote.id)}>
                                    <Trash2 className="h-4 w-4 text-destructive" />
                                </Button>
                            </div>
                        </div>

                        <blockquote className="border-l-4 border-primary pl-4 my-4 italic text-lg">"{quote.quote_text}"</blockquote>

                        {(quote.page_number || quote.chapter) && (
                            <div className="flex gap-4 text-sm text-muted-foreground mb-2">
                                {quote.page_number && <span>Page {quote.page_number}</span>}
                                {quote.chapter && <span>{quote.chapter}</span>}
                            </div>
                        )}

                        {quote.note && <div className="mt-3 p-3 bg-muted/50 rounded-lg"><p className="text-sm text-muted-foreground"><strong>Note:</strong> {quote.note}</p></div>}

                        <div className="mt-4 text-xs text-muted-foreground">Saved {new Date(quote.created_at).toLocaleDateString()}</div>
                    </Card>
                ))}
            </div>
        </div>
    )
}


========== FILE: components\features\reader\epub-viewer.tsx ==========
"use client"

import { useEffect, useRef, useState } from "react"
import Epub from "epubjs"
import { Button } from "@/components/ui/button"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { GamificationService } from "@/lib/gamification"

interface EpubViewerProps {
    url: string
    initialLocation?: string | number
    onLocationChange?: (location: string, progress: number) => void
    readerTheme?: 'light' | 'dark' | 'sepia'
    userId: string
    bookId: string
    onLocationUpdate?: (data: { currentPage?: number; currentCFI?: string; progressPercentage?: number }) => void
}

export function EpubViewer({ url, initialLocation, onLocationChange, readerTheme = 'light', userId, bookId, onLocationUpdate }: EpubViewerProps) {
    const viewerRef = useRef<HTMLDivElement>(null)
    const renditionRef = useRef<any>(null)
    const bookRef = useRef<any>(null)
    const saveProgressDebounced = useRef<NodeJS.Timeout | undefined>(undefined)
    const [isReady, setIsReady] = useState(false)
    const [currentCfi, setCurrentCfi] = useState<string>("")
    const [progress, setProgress] = useState(0)

    const saveProgress = async (cfi: string, progressValue: number) => {
        const supabase = createBrowserSupabaseClient()

        await supabase
            .from('reading_progress')
            .upsert({
                book_id: bookId,
                user_id: userId,
                current_page: 0, // Epub doesn't have linear pages nicely mapped to numbers usually so we trust percentage
                progress_percentage: progressValue,
                epub_cfi: cfi,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'book_id,user_id'
            })
    }

    // Debounced save to prevent excessive writes
    const debouncedSave = (cfi: string, progressValue: number) => {
        if (saveProgressDebounced.current) {
            clearTimeout(saveProgressDebounced.current)
        }
        saveProgressDebounced.current = setTimeout(() => {
            saveProgress(cfi, progressValue)
        }, 2000) // Save 2 seconds after last location change
    }

    const updateProgress = () => {
        if (!bookRef.current || !renditionRef.current) return

        const currentLocation = renditionRef.current.currentLocation()
        if (currentLocation && currentLocation.start) {
            const cfi = currentLocation.start.cfi
            // Get percentage
            const percentage = bookRef.current.locations.percentageFromCfi(cfi)
            const progressValue = Math.round(percentage * 100)

            setProgress(progressValue)

            if (onLocationChange) {
                onLocationChange(cfi, progressValue)
            }

            if (onLocationUpdate) {
                onLocationUpdate({
                    currentCFI: cfi,
                    progressPercentage: progressValue
                })
            }

            // Use debounced save instead of immediate save
            debouncedSave(cfi, progressValue)
        }
    }

    useEffect(() => {
        if (!viewerRef.current) return

        const book = Epub(url)
        bookRef.current = book

        const rendition = book.renderTo(viewerRef.current, {
            width: "100%",
            height: "100%",
            flow: "paginated",
            manager: "default",
        })
        renditionRef.current = rendition

        const initBook = async () => {
            await book.ready

            // Display initial location or start
            if (initialLocation) {
                await rendition.display(initialLocation.toString())
            } else {
                await rendition.display()
            }

            // Generate locations for progress tracking
            book.locations.generate(1000).then(() => {
                setIsReady(true)
                updateProgress()
            })

            // Listen for relocation events
            rendition.on("relocated", (location: any) => {
                setCurrentCfi(location.start.cfi)
                updateProgress()
            })
        }

        initBook()

        return () => {
            if (bookRef.current) {
                bookRef.current.destroy()
            }
        }
    }, [url])

    // Handle Theme Changes
    useEffect(() => {
        if (!renditionRef.current) return

        const themes = renditionRef.current.themes

        // Register themes
        themes.register("light", { body: { color: "#000000", background: "#ffffff" } })
        themes.register("dark", { body: { color: "#ffffff", background: "#1a1a1a" } })
        themes.register("sepia", { body: { color: "#5f4b32", background: "#f6f1d1" } })

        // Select theme
        themes.select(readerTheme)
    }, [readerTheme, isReady])

    // Track reading time and award XP
    useEffect(() => {
        let sessionStart = Date.now()

        const interval = setInterval(async () => {
            if (isReady) {
                const minutesRead = Math.round((Date.now() - sessionStart) / 60000)

                if (minutesRead >= 1) {
                    const supabase = createBrowserSupabaseClient()

                    // Create reading session record
                    await supabase
                        .from('reading_sessions')
                        .insert({
                            user_id: userId,
                            book_id: bookId,
                            duration_minutes: 1,
                            session_date: new Date().toISOString().split('T')[0]
                        })

                    // Award XP
                    await GamificationService.awardXP(userId, 1, "Reading Time", bookId)

                    // Reset session start
                    sessionStart = Date.now()
                }
            }
        }, 60000) // Every minute

        return () => clearInterval(interval)
    }, [userId, isReady, bookId])

    const prevPage = () => {
        if (renditionRef.current) {
            renditionRef.current.prev()
        }
    }

    const nextPage = () => {
        if (renditionRef.current) {
            renditionRef.current.next()
        }
    }

    return (
        <div className="flex flex-col h-full relative group">
            <div className="flex-1 relative">
                <div ref={viewerRef} className="h-full w-full" />

                {/* Navigation Overlays */}
                <div className="absolute inset-y-0 left-0 w-16 flex items-center justify-start opacity-0 group-hover:opacity-100 transition-opacity">
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-12 w-12 rounded-full bg-background/80 shadow-md ml-4"
                        onClick={prevPage}
                    >
                        <ChevronLeft className="h-6 w-6" />
                    </Button>
                </div>
                <div className="absolute inset-y-0 right-0 w-16 flex items-center justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-12 w-12 rounded-full bg-background/80 shadow-md mr-4"
                        onClick={nextPage}
                    >
                        <ChevronRight className="h-6 w-6" />
                    </Button>
                </div>
            </div>

            <div className="h-8 border-t bg-background flex items-center justify-center text-xs text-muted-foreground">
                {progress}% Read
            </div>
        </div>
    )
}


========== FILE: components\features\reader\pdf-viewer.tsx ==========
"use client"

import { useState, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { ChevronLeft, ChevronRight, ZoomIn, ZoomOut } from "lucide-react";
import { Document, Page, pdfjs } from 'react-pdf';
import 'react-pdf/dist/Page/AnnotationLayer.css';
import 'react-pdf/dist/Page/TextLayer.css';
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { GamificationService } from "@/lib/gamification";
import { format } from "date-fns";

// Configure PDF.js worker
pdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`;

interface PDFViewerProps {
    fileUrl: string;
    bookId: string;
    userId: string;
    readerTheme?: 'light' | 'dark' | 'sepia';
    onLocationUpdate?: (data: { currentPage?: number; currentCFI?: string; progressPercentage?: number }) => void;
    initialPage?: number;
}

export function PDFViewer({ fileUrl, bookId, userId, readerTheme = 'light', onLocationUpdate, initialPage }: PDFViewerProps) {
    const [numPages, setNumPages] = useState<number>(0);
    const [pageNumber, setPageNumber] = useState<number>(1);
    const [scale, setScale] = useState<number>(1.0);
    const [loading, setLoading] = useState(true);

    const supabase = createBrowserSupabaseClient()

    // Load bookmark or saved progress on mount
    useEffect(() => {
        // If we have initialPage (from bookmark), use that
        if (initialPage && initialPage > 0) {
            setPageNumber(initialPage);
            return;
        }

        // Otherwise load from reading progress
        const loadProgress = async () => {
            const { data } = await supabase
                .from('reading_progress')
                .select('current_page')
                .eq('book_id', bookId)
                .eq('user_id', userId)
                .single();

            if (data?.current_page) {
                setPageNumber(data.current_page);
            }
        };
        loadProgress();
    }, [bookId, userId, initialPage]);

    // Save progress when page changes (DEBOUNCED)
    useEffect(() => {
        if (pageNumber > 0 && numPages > 0) {
            const progressPercentage = Math.round((pageNumber / numPages) * 100);

            // Notify parent about location change
            if (onLocationUpdate) {
                onLocationUpdate({
                    currentPage: pageNumber,
                    progressPercentage
                });
            }

            // Debounced save - only save after user stops changing pages
            const saveTimeout = setTimeout(async () => {
                await supabase
                    .from('reading_progress')
                    .upsert({
                        book_id: bookId,
                        user_id: userId,
                        current_page: pageNumber,
                        total_pages: numPages,
                        progress_percentage: progressPercentage,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'book_id,user_id'
                    });
            }, 1000); // Save 1 second after last page change

            return () => clearTimeout(saveTimeout);
        }
    }, [pageNumber, numPages, bookId, userId, onLocationUpdate]);

    // Track reading time and award XP
    useEffect(() => {
        let sessionStart = Date.now()

        const interval = setInterval(async () => {
            // Check if actively reading
            if (!loading && numPages > 0) {
                const minutesRead = Math.round((Date.now() - sessionStart) / 60000)

                if (minutesRead >= 1) {
                    // Create reading session record
                    await supabase
                        .from('reading_sessions')
                        .insert({
                            user_id: userId,
                            book_id: bookId,
                            duration_minutes: 1,
                            // Use local date to avoid timezone issues with charts
                            // Use local date to avoid timezone issues with charts
                            session_date: format(new Date(), 'yyyy-MM-dd')
                        })

                    // Award XP
                    await GamificationService.awardXP(userId, 1, "Reading Time", bookId)

                    // Reset session start
                    sessionStart = Date.now()
                }
            }
        }, 60000) // Every minute

        return () => clearInterval(interval)
    }, [userId, loading, numPages, bookId])

    function onDocumentLoadSuccess({ numPages }: { numPages: number }) {
        setNumPages(numPages);
        setLoading(false);
    }

    // Theme styles with CSS filters for PDF
    const themeStyles = {
        light: {
            background: 'bg-muted/30',
            pageBackground: 'bg-white',
            filter: 'none'
        },
        dark: {
            background: 'bg-gray-900',
            pageBackground: 'bg-gray-800',
            filter: 'invert(1) hue-rotate(180deg)' // Invert colors for dark mode
        },
        sepia: {
            background: 'bg-amber-50',
            pageBackground: 'bg-amber-100',
            filter: 'sepia(0.5) brightness(1.1)' // Apply sepia tone
        }
    };

    const currentTheme = themeStyles[readerTheme];

    return (
        <div className="flex flex-col h-full">
            {/* Toolbar */}
            <div className="h-12 border-b bg-background flex items-center justify-between px-4">
                <div className="flex items-center gap-2">
                    <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setScale(prev => Math.max(prev - 0.1, 0.5))}
                        disabled={scale <= 0.5}
                    >
                        <ZoomOut className="h-4 w-4" />
                    </Button>
                    <span className="text-xs font-medium w-12 text-center">{Math.round(scale * 100)}%</span>
                    <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setScale(prev => Math.min(prev + 0.1, 2.0))}
                        disabled={scale >= 2.0}
                    >
                        <ZoomIn className="h-4 w-4" />
                    </Button>
                </div>
            </div>

            {/* Viewer */}
            <div className={`flex-1 overflow-auto flex justify-center p-8 ${currentTheme.background}`}>
                <div className="shadow-2xl">
                    <Document
                        file={fileUrl}
                        onLoadSuccess={onDocumentLoadSuccess}
                        loading={
                            <div className="flex items-center justify-center h-96 w-full">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                            </div>
                        }
                        error={
                            <div className="flex items-center justify-center h-96 w-full text-destructive">
                                Failed to load PDF. Please try again.
                            </div>
                        }
                    >
                        <div style={{ filter: currentTheme.filter }}>
                            <Page
                                pageNumber={pageNumber}
                                scale={scale}
                                renderTextLayer={true}
                                renderAnnotationLayer={true}
                                className={currentTheme.pageBackground}
                            />
                        </div>
                    </Document>
                </div>
            </div>

            {/* Footer Controls */}
            <div className="h-16 border-t bg-background flex items-center justify-center gap-4 px-4 z-10">
                <Button
                    variant="outline"
                    size="icon"
                    onClick={() => setPageNumber(prev => Math.max(prev - 1, 1))}
                    disabled={pageNumber <= 1}
                >
                    <ChevronLeft className="h-4 w-4" />
                </Button>
                <span className="text-sm font-medium">
                    Page {pageNumber} of {numPages || '--'}
                </span>
                <Button
                    variant="outline"
                    size="icon"
                    onClick={() => setPageNumber(prev => Math.min(prev + 1, numPages))}
                    disabled={pageNumber >= numPages}
                >
                    <ChevronRight className="h-4 w-4" />
                </Button>
            </div>
        </div>
    );
}


========== FILE: components\features\reader\reader-layout.tsx ==========
"use client"

import { Button } from "@/components/ui/button"
import { ArrowLeft, Settings, Bookmark } from "lucide-react"
import Link from "next/link"
import React, { useState, useEffect, ReactElement, useCallback } from "react"
import { ReaderSettings } from "@/components/features/reader/reader-settings"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"

interface LocationData {
    currentPage?: number;
    currentCFI?: string;
    progressPercentage?: number;
}

interface ReaderLayoutProps {
    children: React.ReactNode;
    title: string;
    bookId: string;
    userId: string;
}

import { toast } from "sonner"

export function ReaderLayout({ children, title, bookId, userId }: ReaderLayoutProps) {
    const [showSettings, setShowSettings] = useState(false)
    const [isBookmarked, setIsBookmarked] = useState(false)
    const [readerTheme, setReaderTheme] = useState<'light' | 'dark' | 'sepia'>('light')
    const [currentLocation, setCurrentLocation] = useState<LocationData>({})

    // Detect location updates
    const handleLocationUpdate = useCallback((data: LocationData) => {
        setCurrentLocation(prev => {
            // Only update if values actually changed to prevent loops
            if (
                prev.currentPage === data.currentPage &&
                prev.currentCFI === data.currentCFI &&
                prev.progressPercentage === data.progressPercentage
            ) {
                return prev
            }
            return { ...prev, ...data }
        })
    }, [])

    const supabase = createBrowserSupabaseClient();

    // Load bookmark status
    useEffect(() => {
        const loadBookmark = async () => {
            const { data } = await supabase
                .from('bookmarks')
                .select('id')
                .eq('book_id', bookId)
                .eq('user_id', userId)
                .single();

            setIsBookmarked(!!data);
        };
        loadBookmark();
    }, [bookId, userId]);

    const handleBookmark = async () => {
        if (isBookmarked) {
            // Remove bookmark
            const { error } = await supabase
                .from('bookmarks')
                .delete()
                .eq('book_id', bookId)
                .eq('user_id', userId);

            if (!error) {
                setIsBookmarked(false);
                toast.success("Bookmark removed")
            }
        } else {
            // Add bookmark with location context
            const { error } = await supabase
                .from('bookmarks')
                .insert({
                    book_id: bookId,
                    user_id: userId,
                    page_number: currentLocation.currentPage,
                    epub_cfi: currentLocation.currentCFI,
                    progress_percentage: currentLocation.progressPercentage,
                    created_at: new Date().toISOString()
                });

            if (!error) {
                setIsBookmarked(true);
                toast.success("Bookmark saved")
            } else {
                toast.error("Failed to save bookmark")
            }
        }
    }



    const handleThemeChange = (theme: 'light' | 'dark' | 'sepia') => {
        setReaderTheme(theme);
    };

    return (
        <div className="flex flex-col h-screen bg-background">
            {/* Header */}
            <header className="h-14 border-b flex items-center justify-between px-4 bg-background z-10">
                <div className="flex items-center gap-4">
                    <Link href="/dashboard/library">
                        <Button variant="ghost" size="icon">
                            <ArrowLeft className="h-5 w-5" />
                        </Button>
                    </Link>
                    <h1 className="font-semibold truncate max-w-[200px] md:max-w-md">{title}</h1>
                </div>
                <div className="flex items-center gap-2">
                    <Button
                        variant="ghost"
                        size="icon"
                        onClick={handleBookmark}
                        className={isBookmarked ? "text-primary" : ""}
                    >
                        <Bookmark className={`h-5 w-5 ${isBookmarked ? "fill-current" : ""}`} />
                    </Button>

                    <Button variant="ghost" size="icon" onClick={() => setShowSettings(!showSettings)}>
                        <Settings className="h-5 w-5" />
                    </Button>
                </div>
            </header>

            {/* Main Content */}
            <main className="flex-1 overflow-hidden relative">
                {React.Children.map(children, child => {
                    if (React.isValidElement(child)) {
                        return React.cloneElement(child as ReactElement<any>, {
                            readerTheme,
                            onLocationUpdate: handleLocationUpdate
                        });
                    }
                    return child;
                })}
                {showSettings && (
                    <div className="absolute top-4 right-4 z-50">
                        <ReaderSettings onThemeChange={handleThemeChange} currentTheme={readerTheme} />
                    </div>
                )}
            </main>
        </div>
    )
}


========== FILE: components\features\reader\reader-settings.tsx ==========
"use client"

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Sun, Moon, Monitor } from "lucide-react"

interface ReaderSettingsProps {
    onThemeChange: (theme: 'light' | 'dark' | 'sepia') => void;
    currentTheme: 'light' | 'dark' | 'sepia';
}

export function ReaderSettings({ onThemeChange, currentTheme }: ReaderSettingsProps) {
    return (
        <Card className="w-72 shadow-xl">
            <CardHeader className="pb-2">
                <CardTitle className="text-sm">Reader Settings</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">\n                <div className="space-y-2">\n                    <label className="text-xs font-medium">Theme</label>
                <div className="flex gap-2">
                    <Button
                        variant={currentTheme === 'light' ? 'default' : 'outline'}
                        size="sm"
                        className="flex-1"
                        onClick={() => onThemeChange('light')}
                    >
                        <Sun className="h-4 w-4 mr-2" /> Light
                    </Button>
                    <Button
                        variant={currentTheme === 'dark' ? 'default' : 'outline'}
                        size="sm"
                        className="flex-1"
                        onClick={() => onThemeChange('dark')}
                    >
                        <Moon className="h-4 w-4 mr-2" /> Dark
                    </Button>
                    <Button
                        variant={currentTheme === 'sepia' ? 'default' : 'outline'}
                        size="sm"
                        className="flex-1"
                        onClick={() => onThemeChange('sepia')}
                    >
                        <Monitor className="h-4 w-4" /> Sepia
                    </Button>
                </div>
            </div>
            </CardContent>
        </Card>
    )
}


========== FILE: components\features\reader\save-quote-button.tsx ==========
"use client"

import { useState } from "react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useAuth } from "@/components/providers/auth-provider"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogDescription } from "@/components/ui/dialog"
import { Quote, Loader2 } from "lucide-react"
import { toast } from "sonner"
import { useRouter } from "next/navigation"

interface SaveQuoteButtonProps {
    bookId: string
    bookTitle: string
    selectedText?: string
}

export function SaveQuoteButton({ bookId, bookTitle, selectedText }: SaveQuoteButtonProps) {
    const { user } = useAuth()
    const router = useRouter()
    const [open, setOpen] = useState(false)
    const [quoteText, setQuoteText] = useState(selectedText || "")
    const [pageNumber, setPageNumber] = useState("")
    const [chapter, setChapter] = useState("")
    const [note, setNote] = useState("")
    const [loading, setLoading] = useState(false)
    const [isFavorite, setIsFavorite] = useState(false)

    const handleSave = async () => {
        if (!user || !quoteText.trim()) return

        setLoading(true)
        try {
            const supabase = createBrowserSupabaseClient()

            const { error } = await supabase
                .from('book_quotes')
                .insert({
                    user_id: user.id,
                    book_id: bookId,
                    quote_text: quoteText.trim(),
                    page_number: pageNumber ? parseInt(pageNumber) : null,
                    chapter: chapter || null,
                    note: note || null,
                    is_favorite: isFavorite
                })

            if (error) throw error

            toast.success("Quote saved!")
            setOpen(false)
            resetForm()
            router.refresh()
        } catch (error) {
            console.error('Save quote error:', error)
            toast.error("Failed to save quote")
        } finally {
            setLoading(false)
        }
    }

    const resetForm = () => {
        setQuoteText("")
        setPageNumber("")
        setChapter("")
        setNote("")
        setIsFavorite(false)
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button variant="outline" size="sm" className="gap-2">
                    <Quote className="h-4 w-4" />
                    Save Quote
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[500px]">
                <DialogHeader>
                    <DialogTitle>Save Quote from {bookTitle}</DialogTitle>
                    <DialogDescription>
                        Save this quote to your personal collection with optional notes.
                    </DialogDescription>
                </DialogHeader>
                <div className="space-y-4 py-4">
                    <div>
                        <label className="text-sm font-medium mb-2 block">Quote</label>
                        <Textarea
                            placeholder="Paste or type the quote..."
                            value={quoteText}
                            onChange={(e) => setQuoteText(e.target.value)}
                            rows={4}
                            className="resize-none"
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-sm font-medium mb-2 block">Page Number (optional)</label>
                            <Input
                                type="number"
                                placeholder="e.g., 42"
                                value={pageNumber}
                                onChange={(e) => setPageNumber(e.target.value)}
                            />
                        </div>
                        <div>
                            <label className="text-sm font-medium mb-2 block">Chapter (optional)</label>
                            <Input
                                placeholder="e.g., Chapter 5"
                                value={chapter}
                                onChange={(e) => setChapter(e.target.value)}
                            />
                        </div>
                    </div>

                    <div>
                        <label className="text-sm font-medium mb-2 block">Personal Note (optional)</label>
                        <Textarea
                            placeholder="Why does this quote resonate with you?"
                            value={note}
                            onChange={(e) => setNote(e.target.value)}
                            rows={2}
                            className="resize-none"
                        />
                    </div>

                    <div className="flex items-center gap-2">
                        <input
                            type="checkbox"
                            id="favorite"
                            checked={isFavorite}
                            onChange={(e) => setIsFavorite(e.target.checked)}
                            className="w-4 h-4"
                        />
                        <label htmlFor="favorite" className="text-sm cursor-pointer">
                            Mark as favorite
                        </label>
                    </div>
                </div>
                <DialogFooter>
                    <Button variant="outline" onClick={() => setOpen(false)} disabled={loading}>
                        Cancel
                    </Button>
                    <Button onClick={handleSave} disabled={!quoteText.trim() || loading}>
                        {loading ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Saving...
                            </>
                        ) : (
                            "Save Quote"
                        )}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}


========== FILE: components\features\reader\txt-viewer.tsx ==========
"use client"

import { useEffect, useRef, useState } from "react"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { GamificationService } from "@/lib/gamification"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"

interface TxtViewerProps {
    url: string
    initialLocation?: string | number
    onLocationChange?: (location: string, progress: number) => void
    readerTheme?: 'light' | 'dark' | 'sepia'
    userId: string
    bookId: string
    onLocationUpdate?: (data: { currentPage?: number; currentCFI?: string; progressPercentage?: number }) => void
}

export function TxtViewer({ url, initialLocation, onLocationChange, readerTheme = 'light', userId, bookId, onLocationUpdate }: TxtViewerProps) {
    const [content, setContent] = useState<string>("")
    const [loading, setLoading] = useState(true)
    const scrollRef = useRef<HTMLDivElement>(null)

    // Theme styles
    const themeStyles = {
        light: {
            background: 'bg-white',
            color: 'text-gray-900',
        },
        dark: {
            background: 'bg-gray-900',
            color: 'text-gray-100',
        },
        sepia: {
            background: 'bg-[#f6f1d1]',
            color: 'text-[#5f4b32]',
        }
    }
    const currentTheme = themeStyles[readerTheme]

    // Track reading time and award XP
    useEffect(() => {
        let sessionStart = Date.now()

        const interval = setInterval(async () => {
            if (!loading && content) {
                const minutesRead = Math.round((Date.now() - sessionStart) / 60000)

                if (minutesRead >= 1) {
                    const supabase = createBrowserSupabaseClient()

                    // Create reading session record
                    await supabase
                        .from('reading_sessions')
                        .insert({
                            user_id: userId,
                            book_id: bookId,
                            duration_minutes: 1,
                            session_date: new Date().toISOString().split('T')[0]
                        })

                    // Award XP
                    await GamificationService.awardXP(userId, 1, "Reading Time", bookId)

                    // Reset session start
                    sessionStart = Date.now()
                }
            }
        }, 60000)

        return () => clearInterval(interval)
    }, [userId, loading, content, bookId])

    useEffect(() => {
        const fetchContent = async () => {
            try {
                const response = await fetch(url)
                const text = await response.text()
                setContent(text)
                setLoading(false)
            } catch (error) {
                console.error("Failed to load text file:", error)
                setLoading(false)
            }
        }

        fetchContent()
    }, [url])

    // Restore scroll position
    useEffect(() => {
        if (!loading && initialLocation && scrollRef.current) {
            const viewport = scrollRef.current.querySelector('[data-radix-scroll-area-viewport]') as HTMLElement
            if (viewport) {
                viewport.scrollTop = Number(initialLocation)
            }
        }
    }, [loading, initialLocation])

    const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {
        const target = e.currentTarget
        const scrollTop = target.scrollTop
        const scrollHeight = target.scrollHeight
        const clientHeight = target.clientHeight

        const progress = Math.round((scrollTop / (scrollHeight - clientHeight)) * 100)

        if (onLocationChange) {
            onLocationChange(scrollTop.toString(), progress)
        }

        // Notify parent about location change
        if (onLocationUpdate) {
            onLocationUpdate({
                progressPercentage: progress
            });
        }

        saveProgress(progress)
    }

    const saveProgress = async (progressValue: number) => {
        // Debounce could be good here but keeping it simple first
        const supabase = createBrowserSupabaseClient()

        // Only save if progress changed significantly?
        // Or assume component state updates are frequent. 
        // We really should debounce this.

        await supabase
            .from('reading_progress')
            .upsert({
                book_id: bookId,
                user_id: userId,
                current_page: 0,
                progress_percentage: progressValue,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'book_id,user_id'
            })
    }

    if (loading) {
        return (
            <div className="flex items-center justify-center h-full">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            </div>
        )
    }

    return (
        <div className={`h-full w-full ${currentTheme.background} ${currentTheme.color} transition-colors duration-300`}>
            <ScrollArea
                className="h-full w-full px-4 md:px-8 py-8"
                ref={scrollRef}
                onScrollCapture={handleScroll}
            >
                <div className="max-w-3xl mx-auto font-serif text-lg leading-relaxed whitespace-pre-wrap pb-20">
                    {content}
                </div>
            </ScrollArea>
        </div>
    )
}


========== FILE: components\features\settings\settings-form.tsx ==========
"use client"

import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Switch } from "@/components/ui/switch"
import { Loader2, Bell, Mail } from "lucide-react"
import { createBrowserSupabaseClient } from "@/lib/supabase/client"
import { useRouter } from "next/navigation"
import { toast } from "sonner"

export function SettingsForm({ profile }: { profile: any | null }) {
    const [fullName, setFullName] = useState(profile?.full_name || "")
    const [username, setUsername] = useState(profile?.username || "")
    const [email, setEmail] = useState(profile?.email || "")
    const [dailyGoal, setDailyGoal] = useState(profile?.daily_goal_minutes ?? 30)
    const [loading, setLoading] = useState(false)
    const [emailNotifications, setEmailNotifications] = useState(true)
    const [inAppNotifications, setInAppNotifications] = useState(true)
    const router = useRouter()
    const supabase = createBrowserSupabaseClient()

    useEffect(() => {
        if (profile) {
            setFullName(profile.full_name || "")
            setUsername(profile.username || "")
            setEmail(profile.email || "")
            setDailyGoal(profile.daily_goal_minutes || 30)
        }
    }, [profile])

    const handleSaveProfile = async () => {
        setLoading(true)
        try {
            // Validate username
            if (username) {
                const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/
                if (!usernameRegex.test(username)) {
                    toast.error("Username must be 3-20 characters and contain only letters, numbers, or underscores.")
                    setLoading(false)
                    return
                }
            }

            // Update profiles table (server RLS requires authenticated user)
            const { error: profileError } = await supabase
                .from('profiles')
                .update({
                    full_name: fullName,
                    username: username || null,
                    daily_goal_minutes: dailyGoal
                })
                .eq('id', profile?.id)

            if (profileError) {
                if ((profileError as any).code === '23505') {
                    toast.error("Username is already taken.")
                    setLoading(false)
                    return
                }
                throw profileError
            }

            // Update email in auth if changed (requires valid session)
            if (email !== profile?.email) {
                const { error: authError } = await supabase.auth.updateUser({ email })
                if (authError) throw authError
            }

            router.refresh()
            toast.success("Profile updated successfully!")
        } catch (error: any) {
            console.error(error)
            toast.error(error.message || "Failed to update profile")
        } finally {
            setLoading(false)
        }
    }

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle>Profile Information</CardTitle>
                    <CardDescription>Update your personal details.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="username">Username</Label>
                        <Input id="username" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Enter a unique username" />
                        <p className="text-xs text-muted-foreground">This will be displayed on your dashboard greeting.</p>
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="name">Full Name</Label>
                        <Input id="name" value={fullName} onChange={(e) => setFullName(e.target.value)} placeholder="Enter your full name" />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="email">Email</Label>
                        <Input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Enter your email" />
                        <p className="text-xs text-muted-foreground">Changing your email will require verification</p>
                    </div>
                </CardContent>
                <CardFooter>
                    <Button onClick={handleSaveProfile} disabled={loading}>
                        {loading ? (<><Loader2 className="mr-2 h-4 w-4 animate-spin" />Saving...</>) : ("Save Changes")}
                    </Button>
                </CardFooter>
            </Card>

            <Card>
                <CardHeader><CardTitle>Reading Goals</CardTitle><CardDescription>Set your daily reading targets.</CardDescription></CardHeader>
                <CardContent className="space-y-6">
                    <div className="space-y-4">
                        <div className="flex items-center justify-between">
                            <Label>Daily Goal</Label>
                            <span className="font-medium">{dailyGoal} minutes</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-xs text-muted-foreground">15m</span>
                            <input type="range" min="15" max="120" step="5" value={dailyGoal} onChange={(e) => setDailyGoal(parseInt(e.target.value))} className="flex-1 h-2 bg-secondary rounded-lg appearance-none cursor-pointer" />
                            <span className="text-xs text-muted-foreground">120m</span>
                        </div>
                        <p className="text-xs text-muted-foreground">Aim to read for at least {dailyGoal} minutes every day to build your streak.</p>
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardHeader><CardTitle>Notification Preferences</CardTitle><CardDescription>Manage how you receive updates and reminders.</CardDescription></CardHeader>
                <CardContent className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div className="space-y-0.5 flex-1">
                            <div className="flex items-center gap-2"><Bell className="h-4 w-4 text-muted-foreground" /><Label>In-App Notifications</Label></div>
                            <p className="text-sm text-muted-foreground">Get notified about streaks, achievements, and reading milestones</p>
                        </div>
                        <Switch checked={inAppNotifications} onCheckedChange={setInAppNotifications} />
                    </div>
                    <div className="flex items-center justify-between">
                        <div className="space-y-0.5 flex-1">
                            <div className="flex items-center gap-2"><Mail className="h-4 w-4 text-muted-foreground" /><Label>Email Updates (Coming Soon)</Label></div>
                            <p className="text-sm text-muted-foreground">Receive weekly reading summaries and motivational messages</p>
                        </div>
                        <Switch checked={emailNotifications} onCheckedChange={setEmailNotifications} disabled />
                    </div>
                </CardContent>
            </Card>
        </div>
    )
}


========== FILE: middleware.ts ==========
// middleware.ts
export const dynamic = "force-dynamic";

import { type NextRequest, NextResponse } from "next/server";
import { createServerClient } from "@supabase/ssr";

export async function middleware(request: NextRequest) {
    const response = NextResponse.next();

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return request.cookies.getAll();
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value, options }) => {
                        response.cookies.set(name, value, options);
                    });
                },
            },
        }
    );

    // keep session fresh (no redirects here)
    await supabase.auth.getSession();

    return response;
}

export const config = {
    matcher: [
        "/((?!_next/static|_next/image|favicon.ico|auth/callback|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
    ],
};

